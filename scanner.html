<!DOCTYPE html>
<html>
<head>
    <title>Coupon Validator - Advertiser Portal</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* ... (keep all existing styles) ... */
        
        /* Add troubleshooting styles */
        .debug-info {
            background: #FFF3E0;
            border: 2px solid #FF9800;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-info h4 {
            color: #E65100;
            margin-bottom: 10px;
        }
        
        .debug-toggle {
            background: #757575;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .debug-toggle:hover {
            background: #616161;
        }
        
        .data-row {
            margin: 5px 0;
            padding: 3px;
            border-bottom: 1px solid #FFE0B2;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h1>üîê Advertiser Scanner</h1>
            <p>Login with your advertiser credentials</p>
            
            <div class="advertiser-id-section">
                <input type="text" 
                       id="advertiserId" 
                       placeholder="Your Advertiser ID (e.g., pharmacy1)"
                       autocomplete="off">
                
                <input type="password" 
                       id="advertiserPassword" 
                       placeholder="Your Password"
                       onkeypress="handleLoginEnter(event)">
                
                <div class="error-message" id="loginError"></div>
                
                <button class="btn btn-login" onclick="login()">
                    üîì Login to Scanner
                </button>
            </div>
            
            <div class="scanner-instruction">
                <p><strong>First time?</strong></p>
                <p>Use any advertiser ID and password (min 6 chars).</p>
                <p>Account will be created automatically.</p>
            </div>
            
            <div class="advertiser-info">
                <h3>üì± How to Use:</h3>
                <p>1. Login with your advertiser credentials</p>
                <p>2. Enter customer's coupon code manually</p>
                <p>3. Validate and mark coupons as used</p>
                <p>4. Track all validations in your dashboard</p>
            </div>
        </div>
        
        <!-- Scanner Section -->
        <div id="scannerSection" class="hidden">
            <h1>üì± Coupon Validator</h1>
            
            <div class="advertiser-info">
                <h3>Logged in as: <span id="loggedInAdvertiser"></span></h3>
                <p>Advertiser ID: <strong><span id="currentAdvertiserId"></span></strong></p>
                <p>Coupons Redeemed: <strong><span id="currentAdvertiserCount"></span></strong></p>
            </div>
            
            <div class="header-controls">
                <button class="btn btn-change-password" onclick="showChangePasswordModal()">
                    üîë Change Password
                </button>
                <button class="btn btn-dashboard" onclick="showDashboard()">
                    üìä Redeemed Coupons
                </button>
                <button class="btn btn-logout" onclick="logout()">
                    üö™ Logout
                </button>
            </div>
            
            <!-- Manual Input Section -->
            <div class="input-group">
                <input type="text" 
                       id="manualCode" 
                       placeholder="Enter coupon code here"
                       onkeypress="handleManualCodeEnter(event)">
                
                <div class="action-buttons">
                    <button class="btn btn-validate" onclick="validateManualCode()">
                        ‚úÖ Validate Code
                    </button>
                    <button class="btn btn-reset" onclick="resetScanner()">
                        üîÑ Reset Scanner
                    </button>
                </div>
            </div>
            
            <!-- Validation Result Section -->
            <div id="resultSection" class="hidden">
                <!-- ... (keep existing result section) ... -->
            </div>
        </div>
        
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="dashboard-section hidden">
            <div class="dashboard-header">
                <h1 style="margin: 0; text-align: left;">üìä Redeemed Coupons Dashboard</h1>
                <div>
                    <span class="debug-toggle" onclick="toggleDebugInfo()">üõ† Debug</span>
                    <button class="btn btn-export" onclick="exportToPDF()">
                        üìÑ Export to PDF
                    </button>
                    <button class="btn btn-back" onclick="backToScanner()">
                        ‚Üê Back to Scanner
                    </button>
                </div>
            </div>
            
            <div class="advertiser-info">
                <h3>Advertiser: <span id="dashboardAdvertiserName"></span></h3>
                <p>ID: <strong><span id="dashboardAdvertiserId"></span></strong> | 
                   Total Redeemed: <strong><span id="dashboardTotalCount"></span></strong></p>
            </div>
            
            <!-- Debug Information -->
            <div id="debugInfo" class="debug-info hidden">
                <h4>Debug Information <span class="debug-toggle" onclick="toggleDebugInfo()">Hide</span></h4>
                <div id="debugContent">
                    <p>Loading debug data...</p>
                </div>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-label">Total Redeemed</div>
                    <div class="stat-number" id="statTotal">0</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">Last 7 Days</div>
                    <div class="stat-number" id="statLast7Days">0</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">Last 30 Days</div>
                    <div class="stat-number" id="statLast30Days">0</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-label">This Month</div>
                    <div class="stat-number" id="statThisMonth">0</div>
                </div>
            </div>
            
            <div class="dashboard-controls">
                <div class="filters">
                    <select id="timeFilter" class="filter-select" onchange="loadDashboardData()">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">Last 7 Days</option>
                        <option value="month">Last 30 Days</option>
                        <option value="year">This Year</option>
                    </select>
                    
                    <select id="sortFilter" class="filter-select" onchange="loadDashboardData()">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="code">Coupon Code</option>
                    </select>
                    
                    <input type="text" 
                           id="searchFilter" 
                           class="filter-select" 
                           placeholder="Search coupon codes..."
                           onkeyup="loadDashboardData()"
                           style="min-width: 200px;">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-export" style="padding: 8px 15px; font-size: 12px;" onclick="refreshDashboard()">
                        üîÑ Refresh
                    </button>
                    <button class="btn btn-export" style="padding: 8px 15px; font-size: 12px; background: #9C27B0;" onclick="testQuery()">
                        üß™ Test Query
                    </button>
                </div>
            </div>
            
            <div id="dashboardContent">
                <div class="loading" id="dashboardLoading">
                    <div class="loading-spinner"></div>
                    <p>Loading redeemed coupons...</p>
                </div>
                
                <div id="dashboardTable" class="hidden">
                    <table class="coupons-table">
                        <thead>
                            <tr>
                                <th>Coupon Code</th>
                                <th>Product</th>
                                <th>Campaign</th>
                                <th>Customer</th>
                                <th>Claimed At</th>
                                <th>Redeemed At</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="couponsTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="noDataMessage" class="no-data hidden">
                    <p>üì≠ No redeemed coupons found for the selected filters.</p>
                    <p>Start by validating and marking coupons as used in the scanner.</p>
                    <p style="font-size: 14px; color: #999; margin-top: 10px;">
                        <strong>Note:</strong> Only shows coupons you have marked as "used".
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div class="modal-overlay" id="passwordModal">
        <!-- ... (keep existing modal) ... -->
    </div>

    <script>
        // === FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyCxuGBz5FNcaXbCNOfoC9ccR5IsZSYS1d4",
            authDomain: "ad-coupon-system.firebasestorage.app",
            projectId: "ad-coupon-system",
            storageBucket: "ad-coupon-system.firebasestorage.app",
            messagingSenderId: "1030272051491",
            appId: "1:1030272051491:web:4ec6ce21336cf511cac496",
            measurementId: "G-PR9E37ZYE2"
        };
        
        // Initialize Firebase with ALL services
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // === ADVERTISER PASSWORD MANAGEMENT ===
        const ADVERTISERS_COLLECTION = 'advertisers';
        let currentAdvertiser = null;
        let html5QrCode = null;
        let currentCouponData = null;
        
        // === DASHBOARD FUNCTIONS (IMPROVED) ===
        async function showDashboard() {
            document.getElementById('scannerSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            
            // Display advertiser info in dashboard
            document.getElementById('dashboardAdvertiserName').textContent = currentAdvertiser.name;
            document.getElementById('dashboardAdvertiserId').textContent = currentAdvertiser.id;
            
            // Load dashboard data
            loadDashboardData();
        }
        
        function backToScanner() {
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('scannerSection').classList.remove('hidden');
            resetScanner();
        }
        
        function toggleDebugInfo() {
            const debugEl = document.getElementById('debugInfo');
            debugEl.classList.toggle('hidden');
        }
        
        async function testQuery() {
            try {
                const debugEl = document.getElementById('debugContent');
                debugEl.innerHTML = '<p>Running test query...</p>';
                
                // Test 1: Check current advertiser
                debugEl.innerHTML += `<div class="data-row">Current Advertiser ID: <strong>${currentAdvertiser.id}</strong></div>`;
                
                // Test 2: Query for redeemed coupons
                const querySnapshot = await db.collection('claims')
                    .where('redeemed', '==', true)
                    .limit(10)
                    .get();
                
                debugEl.innerHTML += `<div class="data-row">Total redeemed coupons in DB: <strong>${querySnapshot.size}</strong></div>`;
                
                // Test 3: Query for advertiser's coupons
                const advertiserQuery = await db.collection('claims')
                    .where('redeemedBy', '==', currentAdvertiser.id)
                    .limit(10)
                    .get();
                
                debugEl.innerHTML += `<div class="data-row">Coupons redeemed by ${currentAdvertiser.id}: <strong>${advertiserQuery.size}</strong></div>`;
                
                // Show sample data
                if (advertiserQuery.size > 0) {
                    debugEl.innerHTML += '<div class="data-row"><strong>Sample Data:</strong></div>';
                    advertiserQuery.forEach(doc => {
                        const data = doc.data();
                        debugEl.innerHTML += `
                            <div class="data-row">
                                Code: ${data.couponCode || 'N/A'} | 
                                Redeemed By: ${data.redeemedBy || 'N/A'} | 
                                Date: ${data.redeemedAt?.toDate?.().toLocaleString() || 'N/A'}
                            </div>
                        `;
                    });
                } else {
                    debugEl.innerHTML += '<div class="data-row" style="color: #f44336;">No coupons found with redeemedBy = ' + currentAdvertiser.id + '</div>';
                    
                    // Show what's actually in the database
                    debugEl.innerHTML += '<div class="data-row"><strong>All redeemed coupons (first 5):</strong></div>';
                    let count = 0;
                    querySnapshot.forEach(doc => {
                        if (count < 5) {
                            const data = doc.data();
                            debugEl.innerHTML += `
                                <div class="data-row">
                                    Code: ${data.couponCode || 'N/A'} | 
                                    Redeemed By: <strong>${data.redeemedBy || 'NOT SET'}</strong> | 
                                    Redeemed: ${data.redeemed || false}
                                </div>
                            `;
                            count++;
                        }
                    });
                }
                
                // Show the debug panel
                document.getElementById('debugInfo').classList.remove('hidden');
                
            } catch (error) {
                document.getElementById('debugContent').innerHTML = 
                    `<p style="color: #f44336;">Error: ${error.message}</p>`;
                document.getElementById('debugInfo').classList.remove('hidden');
            }
        }
        
        async function loadDashboardData() {
            const loadingEl = document.getElementById('dashboardLoading');
            const tableEl = document.getElementById('dashboardTable');
            const noDataEl = document.getElementById('noDataMessage');
            const tableBody = document.getElementById('couponsTableBody');
            
            // Show loading
            loadingEl.classList.remove('hidden');
            tableEl.classList.add('hidden');
            noDataEl.classList.add('hidden');
            
            // Clear table
            tableBody.innerHTML = '';
            
            try {
                // Build query - IMPORTANT: Use exact advertiser ID
                let query = db.collection('claims')
                    .where('redeemedBy', '==', currentAdvertiser.id)
                    .where('redeemed', '==', true);
                
                // Apply time filter
                const timeFilter = document.getElementById('timeFilter').value;
                const now = new Date();
                
                if (timeFilter !== 'all') {
                    let startDate = new Date();
                    
                    switch(timeFilter) {
                        case 'today':
                            startDate.setHours(0, 0, 0, 0);
                            break;
                        case 'week':
                            startDate.setDate(now.getDate() - 7);
                            break;
                        case 'month':
                            startDate.setDate(now.getDate() - 30);
                            break;
                        case 'year':
                            startDate.setFullYear(now.getFullYear(), 0, 1);
                            break;
                    }
                    
                    query = query.where('redeemedAt', '>=', startDate);
                }
                
                // Apply sorting
                const sortFilter = document.getElementById('sortFilter').value;
                switch(sortFilter) {
                    case 'oldest':
                        query = query.orderBy('redeemedAt', 'asc');
                        break;
                    case 'code':
                        query = query.orderBy('couponCode', 'asc');
                        break;
                    default: // newest
                        query = query.orderBy('redeemedAt', 'desc');
                        break;
                }
                
                // Apply search filter
                const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
                
                // Get data
                console.log('Executing query for advertiser:', currentAdvertiser.id);
                const querySnapshot = await query.get();
                console.log('Query returned:', querySnapshot.size, 'documents');
                
                // Process results
                let coupons = [];
                let totalCount = 0;
                let last7DaysCount = 0;
                let last30DaysCount = 0;
                let thisMonthCount = 0;
                
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const redeemedAt = data.redeemedAt?.toDate();
                    const claimedAt = data.claimedAt?.toDate();
                    
                    // Apply search filter
                    if (searchTerm && !data.couponCode?.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                    
                    // Only include if redeemedBy matches exactly
                    if (data.redeemedBy !== currentAdvertiser.id) {
                        console.log('Skipping coupon with redeemedBy:', data.redeemedBy);
                        return;
                    }
                    
                    totalCount++;
                    
                    // Count stats
                    if (redeemedAt) {
                        if (redeemedAt >= sevenDaysAgo) last7DaysCount++;
                        if (redeemedAt >= thirtyDaysAgo) last30DaysCount++;
                        if (redeemedAt >= thisMonthStart) thisMonthCount++;
                    }
                    
                    coupons.push({
                        id: doc.id,
                        ...data,
                        claimedAt: claimedAt,
                        redeemedAt: redeemedAt
                    });
                });
                
                console.log('Processed coupons:', coupons.length);
                
                // Update stats
                document.getElementById('statTotal').textContent = totalCount;
                document.getElementById('statLast7Days').textContent = last7DaysCount;
                document.getElementById('statLast30Days').textContent = last30DaysCount;
                document.getElementById('statThisMonth').textContent = thisMonthCount;
                
                // Update header counts
                document.getElementById('dashboardTotalCount').textContent = totalCount;
                
                // Populate table
                if (coupons.length > 0) {
                    coupons.forEach(coupon => {
                        const row = document.createElement('tr');
                        
                        const claimedDate = coupon.claimedAt ? 
                            coupon.claimedAt.toLocaleDateString() + ' ' + coupon.claimedAt.toLocaleTimeString().substring(0, 5) :
                            'Unknown';
                        
                        const redeemedDate = coupon.redeemedAt ? 
                            coupon.redeemedAt.toLocaleDateString() + ' ' + coupon.redeemedAt.toLocaleTimeString().substring(0, 5) :
                            'Unknown';
                        
                        row.innerHTML = `
                            <td class="coupon-code-cell">${coupon.couponCode || 'Unknown'}</td>
                            <td>${coupon.productName || 'Unknown'}</td>
                            <td>${coupon.adName || 'Unknown'}</td>
                            <td>${coupon.userId ? coupon.userId.substring(0, 8) + '...' : 'Unknown'}</td>
                            <td>${claimedDate}</td>
                            <td>${redeemedDate}</td>
                            <td><span class="status-badge ${coupon.redeemed ? 'status-redeemed' : 'status-pending'}">
                                ${coupon.redeemed ? 'Redeemed' : 'Pending'}
                            </span></td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    tableEl.classList.remove('hidden');
                } else {
                    noDataEl.classList.remove('hidden');
                }
                
                loadingEl.classList.add('hidden');
                
            } catch (error) {
                console.error('Dashboard load error:', error);
                loadingEl.classList.add('hidden');
                noDataEl.innerHTML = `
                    <p>‚ùå Error loading data: ${error.message}</p>
                    <p style="font-size: 14px; color: #999; margin-top: 10px;">
                        Common issues:<br>
                        1. Firebase permissions<br>
                        2. No coupons redeemed yet<br>
                        3. Network connection
                    </p>
                `;
                noDataEl.classList.remove('hidden');
            }
        }
        
        function refreshDashboard() {
            loadDashboardData();
        }
        
        async function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(20);
                doc.setTextColor(51, 51, 51);
                doc.text(`Redeemed Coupons Report - ${currentAdvertiser.name}`, 20, 20);
                
                // Add subtitle
                doc.setFontSize(12);
                doc.setTextColor(102, 102, 102);
                doc.text(`Generated on ${new Date().toLocaleDateString()}`, 20, 30);
                doc.text(`Advertiser ID: ${currentAdvertiser.id}`, 20, 37);
                
                // Get table data
                const tableBody = document.getElementById('couponsTableBody');
                const rows = tableBody.querySelectorAll('tr');
                
                if (rows.length === 0) {
                    doc.setFontSize(14);
                    doc.text('No redeemed coupons found.', 20, 50);
                    doc.save(`coupons-report-${currentAdvertiser.id}-${Date.now()}.pdf`);
                    return;
                }
                
                // Prepare data for table
                const tableData = [];
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 6) {
                        tableData.push([
                            cells[0].textContent,
                            cells[1].textContent,
                            cells[2].textContent,
                            cells[4].textContent, // Claimed At
                            cells[5].textContent  // Redeemed At
                        ]);
                    }
                });
                
                // Add table
                doc.autoTable({
                    head: [['Coupon Code', 'Product', 'Campaign', 'Claimed At', 'Redeemed At']],
                    body: tableData,
                    startY: 50,
                    theme: 'striped',
                    headStyles: { fillColor: [76, 175, 80] },
                    styles: { fontSize: 8, cellPadding: 3 },
                    columnStyles: {
                        0: { cellWidth: 35 },
                        1: { cellWidth: 35 },
                        2: { cellWidth: 35 },
                        3: { cellWidth: 40 },
                        4: { cellWidth: 40 }
                    },
                    margin: { left: 20 }
                });
                
                // Save PDF
                doc.save(`coupons-report-${currentAdvertiser.id}-${Date.now()}.pdf`);
                
                alert('‚úÖ PDF exported successfully!');
                
            } catch (error) {
                console.error('PDF export error:', error);
                alert('‚ùå Error exporting PDF: ' + error.message);
            }
        }
        
        // === LOGIN AND SCANNER FUNCTIONS ===
        // ... (keep all existing login and scanner functions from previous code) ...
        
        // Make sure markCouponUsed function properly sets redeemedBy
        async function markCouponUsed() {
            try {
                const couponCode = currentCouponData.couponCode;
                
                // For test accounts
                if (currentAdvertiser?.isTest) {
                    document.getElementById('validResult').classList.add('hidden');
                    document.getElementById('successResult').classList.remove('hidden');
                    document.getElementById('successCouponCode').textContent = couponCode;
                    
                    currentAdvertiser.couponValidations = (currentAdvertiser.couponValidations || 0) + 1;
                    document.getElementById('currentAdvertiserCount').textContent = currentAdvertiser.couponValidations;
                    
                    setTimeout(() => {
                        resetScanner();
                    }, 2000);
                    return;
                }
                
                // Update the coupon as redeemed - MAKE SURE redeemedBy is set!
                await db.collection('claims').doc(currentCouponData.id).update({
                    redeemed: true,
                    redeemedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    redeemedBy: currentAdvertiser.id,
                    redeemedByName: currentAdvertiser.name,
                    redeemedByAdvertiserId: currentAdvertiser.id // Additional field for clarity
                });
                
                // Update advertiser validation count
                await db.collection(ADVERTISERS_COLLECTION)
                    .doc(currentAdvertiser.id)
                    .update({
                        couponValidations: firebase.firestore.FieldValue.increment(1),
                        lastValidation: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                // Update current advertiser count
                currentAdvertiser.couponValidations = (currentAdvertiser.couponValidations || 0) + 1;
                document.getElementById('currentAdvertiserCount').textContent = currentAdvertiser.couponValidations;
                
                // Show success
                document.getElementById('validResult').classList.add('hidden');
                document.getElementById('successResult').classList.remove('hidden');
                document.getElementById('successCouponCode').textContent = couponCode;
                
                // Refresh dashboard if it's open
                if (!document.getElementById('dashboardSection').classList.contains('hidden')) {
                    loadDashboardData();
                }
                
                setTimeout(() => {
                    resetScanner();
                }, 3000);
                
            } catch (error) {
                alert('‚ùå Error marking coupon as used: ' + error.message);
            }
        }
        
        // Initialize on page load WITH AUTH
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await auth.signInAnonymously();
                console.log("‚úÖ Firebase Auth: Signed in anonymously");
                
                // Check if already logged in from session
                const savedAdvertiser = sessionStorage.getItem('advertiser_logged_in');
                if (savedAdvertiser) {
                    try {
                        currentAdvertiser = JSON.parse(savedAdvertiser);
                        showScannerSection();
                    } catch (e) {
                        console.error("Session parse error:", e);
                        sessionStorage.removeItem('advertiser_logged_in');
                    }
                }
                
                document.getElementById('advertiserId').focus();
                
            } catch (error) {
                console.error("Auth initialization error:", error);
                document.getElementById('loginError').textContent = 
                    '‚ùå Authentication error: ' + error.message;
            }
        });
        
        // ... (include all other existing functions: login, logout, scanner functions, etc.) ...
    </script>
</body>
</html>
