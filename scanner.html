<!DOCTYPE html>
<html>
<head>
    <title>Coupon Validator - Advertiser Portal</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container { 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            max-width: 900px; 
            width: 100%; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
        }
        
        h1 { 
            color: #333; 
            margin-bottom: 10px; 
            text-align: center;
            font-size: 28px;
        }
        
        h2 {
            color: #333;
            margin: 15px 0;
            font-size: 22px;
        }
        
        .hidden { display: none !important; }
        
        /* Login Section */
        .login-section {
            text-align: center;
        }
        
        .advertiser-info {
            background: #E8F5E9;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        /* Dashboard Section */
        .dashboard-section {
            text-align: center;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-export {
            background: #4CAF50;
            color: white;
        }
        
        .btn-export:hover {
            background: #45a049;
        }
        
        .btn-back {
            background: #757575;
            color: white;
        }
        
        .btn-back:hover {
            background: #616161;
        }
        
        .btn-logout {
            background: #f44336;
            color: white;
        }
        
        .btn-logout:hover {
            background: #d32f2f;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border-left: 5px solid #4CAF50;
        }
        
        .stat-card.orange { border-left-color: #FF9800; }
        .stat-card.blue { border-left-color: #2196F3; }
        .stat-card.purple { border-left-color: #9C27B0; }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .filter-select, input[type="text"] {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-width: 150px;
        }
        
        .coupons-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .coupons-table th {
            background: #4CAF50;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .coupons-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .coupons-table tr:hover {
            background: #f5f5f5;
        }
        
        .coupon-code-cell {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #333;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-redeemed {
            background: #4CAF50;
            color: white;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* Login form */
        .input-group {
            margin-bottom: 20px;
        }
        
        input[type="text"], 
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .error-message {
            color: #f44336;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
            min-height: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                max-width: 100%;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-select, input[type="text"] {
                width: 100%;
            }
            
            .coupons-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h1>üîê Advertiser Dashboard Login</h1>
            <p>Enter your advertiser credentials</p>
            
            <div class="input-group">
                <input type="text" 
                       id="advertiserId" 
                       placeholder="Your Advertiser ID"
                       autocomplete="off">
                
                <input type="password" 
                       id="advertiserPassword" 
                       placeholder="Your Password"
                       onkeypress="handleLoginEnter(event)">
                
                <div class="error-message" id="loginError"></div>
                
                <button class="btn btn-export" onclick="login()" style="width: 100%; padding: 12px;">
                    üîì Login to Dashboard
                </button>
            </div>
            
            <div class="advertiser-info">
                <h3>üìä Dashboard Features:</h3>
                <p>‚Ä¢ View only YOUR redeemed coupons</p>
                <p>‚Ä¢ Filter by date and search</p>
                <p>‚Ä¢ Export to PDF report</p>
                <p>‚Ä¢ Track redemption statistics</p>
            </div>
        </div>
        
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="dashboard-section hidden">
            <div class="dashboard-header">
                <h1 style="margin: 0; text-align: left;">üìä Redeemed Coupons Dashboard</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-export" onclick="exportToPDF()">
                        üìÑ Export to PDF
                    </button>
                    <button class="btn btn-back" onclick="logout()">
                        üö™ Logout
                    </button>
                </div>
            </div>
            
            <div class="advertiser-info">
                <h3 style="margin: 0;">Advertiser: <span id="dashboardAdvertiserName"></span></h3>
                <p style="margin: 5px 0;">ID: <strong><span id="dashboardAdvertiserId"></span></strong> | 
                   Total Redeemed: <strong><span id="dashboardTotalCount"></span></strong></p>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-label">Total Redeemed</div>
                    <div class="stat-number" id="statTotal">0</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">Today</div>
                    <div class="stat-number" id="statToday">0</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">This Week</div>
                    <div class="stat-number" id="statThisWeek">0</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-label">This Month</div>
                    <div class="stat-number" id="statThisMonth">0</div>
                </div>
            </div>
            
            <div class="filters">
                <select id="timeFilter" class="filter-select" onchange="loadDashboardData()">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="year">This Year</option>
                </select>
                
                <select id="sortFilter" class="filter-select" onchange="loadDashboardData()">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                </select>
                
                <input type="text" 
                       id="searchFilter" 
                       class="filter-select" 
                       placeholder="Search coupon codes..."
                       onkeyup="loadDashboardData()"
                       style="flex-grow: 1;">
                
                <button class="btn btn-export" onclick="loadDashboardData()" style="padding: 10px 20px;">
                    üîÑ Refresh
                </button>
            </div>
            
            <div id="dashboardContent">
                <div class="loading" id="dashboardLoading">
                    <div class="loading-spinner"></div>
                    <p>Loading your redeemed coupons...</p>
                </div>
                
                <div id="dashboardTable" class="hidden">
                    <table class="coupons-table">
                        <thead>
                            <tr>
                                <th>Coupon Code</th>
                                <th>Product</th>
                                <th>Campaign</th>
                                <th>Claimed At</th>
                                <th>Redeemed At</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="couponsTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="noDataMessage" class="no-data hidden">
                    <p>üì≠ No redeemed coupons found.</p>
                    <p>Start by validating and marking coupons as used in the scanner.</p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-back" onclick="checkDatabaseStructure()">
                    üîç Check Database
                </button>
            </div>
        </div>
    </div>

    <script>
        // === FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyCxuGBz5FNcaXbCNOfoC9ccR5IsZSYS1d4",
            authDomain: "ad-coupon-system.firebaseapp.com",
            projectId: "ad-coupon-system",
            storageBucket: "ad-coupon-system.firebasestorage.app",
            messagingSenderId: "1030272051491",
            appId: "1:1030272051491:web:4ec6ce21336cf511cac496",
            measurementId: "G-PR9E37ZYE2"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentAdvertiser = null;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await auth.signInAnonymously();
                console.log("‚úÖ Firebase connected");
                
                // Check if already logged in
                const savedAdvertiser = localStorage.getItem('advertiser_dashboard_logged_in');
                if (savedAdvertiser) {
                    try {
                        currentAdvertiser = JSON.parse(savedAdvertiser);
                        showDashboardSection();
                        loadDashboardData();
                    } catch (e) {
                        localStorage.removeItem('advertiser_dashboard_logged_in');
                    }
                }
                
                document.getElementById('advertiserId').focus();
                
            } catch (error) {
                console.error("Auth error:", error);
                document.getElementById('loginError').textContent = 
                    '‚ùå Connection error: ' + error.message;
            }
        });
        
        // === LOGIN FUNCTIONS ===
        async function login() {
            const advertiserId = document.getElementById('advertiserId').value.trim().toLowerCase();
            const password = document.getElementById('advertiserPassword').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            errorDiv.textContent = '';
            
            if (!advertiserId) {
                errorDiv.textContent = '‚ùå Please enter Advertiser ID';
                document.getElementById('advertiserId').focus();
                return;
            }
            
            if (!password) {
                errorDiv.textContent = '‚ùå Please enter password';
                document.getElementById('advertiserPassword').focus();
                return;
            }
            
            try {
                // For testing - you can remove this later
                if (advertiserId === 'test' && password === 'test123') {
                    currentAdvertiser = {
                        id: 'test',
                        name: 'Test Advertiser'
                    };
                    localStorage.setItem('advertiser_dashboard_logged_in', JSON.stringify(currentAdvertiser));
                    showDashboardSection();
                    return;
                }
                
                // Check if advertiser exists
                const advertiserDoc = await db.collection('advertisers')
                    .doc(advertiserId)
                    .get();
                
                if (!advertiserDoc.exists) {
                    errorDiv.textContent = '‚ùå Advertiser not found';
                    return;
                }
                
                const advertiserData = advertiserDoc.data();
                
                // Verify password
                if (advertiserData.password !== password) {
                    errorDiv.textContent = '‚ùå Incorrect password';
                    document.getElementById('advertiserPassword').value = '';
                    document.getElementById('advertiserPassword').focus();
                    return;
                }
                
                currentAdvertiser = {
                    id: advertiserId,
                    name: advertiserData.name || advertiserId,
                    couponValidations: advertiserData.couponValidations || 0
                };
                
                // Save to localStorage
                localStorage.setItem('advertiser_dashboard_logged_in', JSON.stringify(currentAdvertiser));
                
                // Clear password field
                document.getElementById('advertiserPassword').value = '';
                
                // Show dashboard
                showDashboardSection();
                loadDashboardData();
                
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = '‚ùå Login error: ' + error.message;
                
                // If permission error, allow test login
                if (error.code === 'permission-denied') {
                    currentAdvertiser = {
                        id: advertiserId,
                        name: advertiserId,
                        couponValidations: 0
                    };
                    localStorage.setItem('advertiser_dashboard_logged_in', JSON.stringify(currentAdvertiser));
                    showDashboardSection();
                }
            }
        }
        
        function handleLoginEnter(event) {
            if (event.key === 'Enter') {
                login();
            }
        }
        
        function showDashboardSection() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            
            document.getElementById('dashboardAdvertiserName').textContent = currentAdvertiser.name;
            document.getElementById('dashboardAdvertiserId').textContent = currentAdvertiser.id;
        }
        
        function logout() {
            localStorage.removeItem('advertiser_dashboard_logged_in');
            currentAdvertiser = null;
            
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            
            document.getElementById('advertiserId').value = '';
            document.getElementById('advertiserPassword').value = '';
            document.getElementById('advertiserId').focus();
        }
        
        // === DASHBOARD FUNCTIONS ===
        async function loadDashboardData() {
            const loadingEl = document.getElementById('dashboardLoading');
            const tableEl = document.getElementById('dashboardTable');
            const noDataEl = document.getElementById('noDataMessage');
            const tableBody = document.getElementById('couponsTableBody');
            
            loadingEl.classList.remove('hidden');
            tableEl.classList.add('hidden');
            noDataEl.classList.add('hidden');
            tableBody.innerHTML = '';
            
            try {
                console.log('Loading dashboard for advertiser:', currentAdvertiser.id);
                
                // Method 1: First try querying by redeemedBy
                let query = db.collection('claims')
                    .where('redeemed', '==', true);
                
                // Try different field names for advertiser ID
                let advertiserField = 'redeemedBy';
                
                // Get ALL redeemed coupons first to see what data we have
                const allRedeemedQuery = await db.collection('claims')
                    .where('redeemed', '==', true)
                    .limit(50)
                    .get();
                
                console.log('Total redeemed coupons in DB:', allRedeemedQuery.size);
                
                // Check what fields exist
                let fieldFound = false;
                if (allRedeemedQuery.size > 0) {
                    const sampleDoc = allRedeemedQuery.docs[0].data();
                    console.log('Sample coupon fields:', Object.keys(sampleDoc));
                    
                    // Check which field contains advertiser info
                    if (sampleDoc.redeemedBy) {
                        advertiserField = 'redeemedBy';
                        fieldFound = true;
                    } else if (sampleDoc.redeemedByAdvertiserId) {
                        advertiserField = 'redeemedByAdvertiserId';
                        fieldFound = true;
                    } else if (sampleDoc.advertiserId) {
                        advertiserField = 'advertiserId';
                        fieldFound = true;
                    }
                }
                
                if (fieldFound) {
                    console.log('Using field for filtering:', advertiserField);
                    query = query.where(advertiserField, '==', currentAdvertiser.id);
                } else {
                    console.log('No advertiser field found, will filter manually');
                }
                
                // Apply time filter
                const timeFilter = document.getElementById('timeFilter').value;
                const now = new Date();
                
                if (timeFilter !== 'all' && fieldFound) {
                    let startDate = new Date();
                    
                    switch(timeFilter) {
                        case 'today':
                            startDate.setHours(0, 0, 0, 0);
                            break;
                        case 'week':
                            startDate.setDate(now.getDate() - 7);
                            break;
                        case 'month':
                            startDate.setMonth(now.getMonth() - 1);
                            break;
                        case 'year':
                            startDate.setFullYear(now.getFullYear() - 1);
                            break;
                    }
                    
                    query = query.where('redeemedAt', '>=', startDate);
                }
                
                // Apply sorting
                const sortFilter = document.getElementById('sortFilter').value;
                if (fieldFound) {
                    query = query.orderBy('redeemedAt', sortFilter === 'oldest' ? 'asc' : 'desc');
                }
                
                // Execute query
                const querySnapshot = fieldFound ? await query.get() : allRedeemedQuery;
                
                // Process results
                let coupons = [];
                let totalCount = 0;
                let todayCount = 0;
                let weekCount = 0;
                let monthCount = 0;
                
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                
                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() - 7);
                
                const monthStart = new Date();
                monthStart.setMonth(monthStart.getMonth() - 1);
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const redeemedAt = data.redeemedAt?.toDate();
                    const claimedAt = data.claimedAt?.toDate();
                    
                    // Apply manual filtering if no field found
                    if (!fieldFound) {
                        // Check if this coupon belongs to current advertiser
                        const redeemedBy = data.redeemedBy || data.redeemedByAdvertiserId || data.advertiserId;
                        if (redeemedBy !== currentAdvertiser.id) {
                            return;
                        }
                    }
                    
                    // Apply search filter
                    const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
                    if (searchTerm && !data.couponCode?.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                    
                    totalCount++;
                    
                    // Count stats
                    if (redeemedAt) {
                        if (redeemedAt >= todayStart) todayCount++;
                        if (redeemedAt >= weekStart) weekCount++;
                        if (redeemedAt >= monthStart) monthCount++;
                    }
                    
                    coupons.push({
                        id: doc.id,
                        ...data,
                        claimedAt: claimedAt,
                        redeemedAt: redeemedAt
                    });
                });
                
                // Apply client-side sorting if no field found
                if (!fieldFound) {
                    coupons.sort((a, b) => {
                        if (sortFilter === 'oldest') {
                            return (a.redeemedAt || 0) - (b.redeemedAt || 0);
                        } else {
                            return (b.redeemedAt || 0) - (a.redeemedAt || 0);
                        }
                    });
                }
                
                console.log('Found coupons for advertiser:', coupons.length);
                
                // Update stats
                document.getElementById('statTotal').textContent = totalCount;
                document.getElementById('statToday').textContent = todayCount;
                document.getElementById('statThisWeek').textContent = weekCount;
                document.getElementById('statThisMonth').textContent = monthCount;
                document.getElementById('dashboardTotalCount').textContent = totalCount;
                
                // Populate table
                if (coupons.length > 0) {
                    coupons.forEach(coupon => {
                        const row = document.createElement('tr');
                        
                        const claimedDate = coupon.claimedAt ? 
                            coupon.claimedAt.toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : 'N/A';
                        
                        const redeemedDate = coupon.redeemedAt ? 
                            coupon.redeemedAt.toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : 'N/A';
                        
                        row.innerHTML = `
                            <td class="coupon-code-cell">${coupon.couponCode || 'N/A'}</td>
                            <td>${coupon.productName || 'N/A'}</td>
                            <td>${coupon.adName || 'N/A'}</td>
                            <td>${claimedDate}</td>
                            <td>${redeemedDate}</td>
                            <td><span class="status-badge status-redeemed">Redeemed</span></td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    tableEl.classList.remove('hidden');
                } else {
                    noDataEl.classList.remove('hidden');
                }
                
                loadingEl.classList.add('hidden');
                
            } catch (error) {
                console.error('Dashboard error:', error);
                loadingEl.classList.add('hidden');
                noDataEl.innerHTML = `
                    <p>‚ùå Error loading data: ${error.message}</p>
                    <p style="font-size: 14px; color: #999; margin-top: 10px;">
                        Click "Check Database" to see what data is available.
                    </p>
                `;
                noDataEl.classList.remove('hidden');
            }
        }
        
        async function checkDatabaseStructure() {
            try {
                alert('Checking database structure...\nCheck browser console for details (F12)');
                
                // Get all claims to see structure
                const claimsSnapshot = await db.collection('claims')
                    .limit(10)
                    .get();
                
                console.log('=== DATABASE STRUCTURE CHECK ===');
                console.log('Total claims in DB:', claimsSnapshot.size);
                
                claimsSnapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('Document ID:', doc.id);
                    console.log('Fields:', Object.keys(data));
                    console.log('Data:', {
                        couponCode: data.couponCode,
                        redeemed: data.redeemed,
                        redeemedBy: data.redeemedBy,
                        redeemedByAdvertiserId: data.redeemedByAdvertiserId,
                        advertiserId: data.advertiserId,
                        redeemedAt: data.redeemedAt?.toDate?.()
                    });
                    console.log('---');
                });
                
                // Get advertisers
                const advertisersSnapshot = await db.collection('advertisers')
                    .limit(5)
                    .get();
                
                console.log('Advertisers in DB:', advertisersSnapshot.size);
                advertisersSnapshot.forEach(doc => {
                    console.log('Advertiser:', doc.id, doc.data());
                });
                
                alert('Check complete! See browser console (F12) for details.');
                
            } catch (error) {
                console.error('Check error:', error);
                alert('Error checking database: ' + error.message);
            }
        }
        
        async function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(18);
                doc.setTextColor(51, 51, 51);
                doc.text(`Redeemed Coupons Report`, 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Advertiser: ${currentAdvertiser.name}`, 20, 30);
                doc.text(`ID: ${currentAdvertiser.id}`, 20, 37);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 44);
                
                // Get table data
                const tableBody = document.getElementById('couponsTableBody');
                const rows = tableBody.querySelectorAll('tr');
                
                if (rows.length === 0) {
                    doc.text('No redeemed coupons found.', 20, 60);
                } else {
                    // Prepare data
                    const tableData = [];
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 5) {
                            tableData.push([
                                cells[0].textContent,
                                cells[1].textContent,
                                cells[2].textContent,
                                cells[3].textContent,
                                cells[4].textContent
                            ]);
                        }
                    });
                    
                    // Add table
                    doc.autoTable({
                        head: [['Coupon Code', 'Product', 'Campaign', 'Claimed', 'Redeemed']],
                        body: tableData,
                        startY: 60,
                        theme: 'striped',
                        headStyles: { fillColor: [76, 175, 80] },
                        styles: { fontSize: 8 },
                        margin: { left: 20 }
                    });
                }
                
                // Save PDF
                doc.save(`coupons-${currentAdvertiser.id}-${Date.now()}.pdf`);
                
                alert('‚úÖ PDF exported successfully!');
                
            } catch (error) {
                console.error('PDF error:', error);
                alert('‚ùå Error exporting PDF: ' + error.message);
            }
        }
    </script>
</body>
</html>
