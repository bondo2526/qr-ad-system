<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coupon Validator - Advertiser Portal</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .header { text-align: center; margin-bottom: 20px; }
    .btn { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .btn-primary { background: #4CAF50; color: white; }
    .btn-secondary { background: #2196F3; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .dashboard { margin-top: 30px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background-color: #f2f2f2; }
    .hidden { display: none; }
    .section { margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
    #loginSection { text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Section (shown if not logged in) -->
    <div id="loginSection" class="hidden">
      <h2>üîê Advertiser Login</h2>
      <input type="email" id="email" placeholder="Email" style="padding:10px; width:70%; margin:5px;" />
      <input type="password" id="password" placeholder="Password" style="padding:10px; width:70%; margin:5px;" />
      <br>
      <button class="btn btn-primary" onclick="login()">Login</button>
      <p><small>Need account? Contact admin.</small></p>
    </div>

    <!-- Main App (hidden until login) -->
    <div id="mainApp" class="hidden">
      <div class="header">
        <h2>üîê Advertiser Scanner</h2>
        <p>Logged in as: <span id="advertiserName">[Loading...]</span><br>
           Advertiser ID: <span id="advertiserId">[ID]</span></p>
      </div>

      <button class="btn btn-secondary" onclick="showDashboard()">üìä Redeemed Coupons Dashboard</button>
      <button class="btn btn-primary" onclick="changePassword()">üîë Change Password</button>
      <button class="btn btn-danger" onclick="logout()">üö™ Logout</button>

      <!-- Validation Section -->
      <div class="section" id="validateSection">
        <h3>üì± Coupon Validator</h3>
        <input type="text" id="couponCode" placeholder="Enter coupon code" style="padding:10px; width:70%" />
        <button class="btn btn-primary" onclick="validateCoupon()">‚úÖ Validate Code</button>
        <button class="btn" onclick="resetScanner()">üîÑ Reset Scanner</button>
      </div>

      <!-- Dashboard Section -->
      <div class="section hidden" id="dashboardSection">
        <h3>üìä Your Redeemed Coupons</h3>
        <button class="btn btn-secondary" onclick="exportToPDF()">üì• Export to PDF</button>
        <button class="btn" onclick="hideDashboard()">‚Üê Back to Scanner</button>
        <table id="redeemedTable">
          <thead>
            <tr>
              <th>Coupon Code</th>
              <th>Customer ID</th>
              <th>Product</th>
              <th>Location</th>
              <th>Claimed At</th>
              <th>Expires</th>
            </tr>
          </thead>
          <tbody id="redeemedTableBody"></tbody>
        </table>
        <p id="noDataMessage" class="hidden">No redeemed coupons yet.</p>
      </div>

      <!-- Change Password -->
      <div class="section hidden" id="passwordSection">
        <h3>üîë Change Your Password</h3>
        <input type="password" id="newPassword" placeholder="New password (min 6 chars)" style="padding:10px; width:70%" />
        <button class="btn btn-primary" onclick="savePassword()">Change Password</button>
        <button class="btn" onclick="cancelPasswordChange()">Cancel</button>
      </div>

      <div id="resultMessage" class="hidden" style="margin-top:20px; padding:15px; border-radius:5px;"></div>
    </div>
  </div>

  <script>
    // üî• REPLACE WITH YOUR FIREBASE CONFIG
    const firebaseConfig = {
            apiKey: "AIzaSyCxuGBz5FNcaXbCNOfoC9ccR5IsZSYS1d4",
            authDomain: "ad-coupon-system.firebaseapp.com",
            projectId: "ad-coupon-system",
            storageBucket: "ad-coupon-system.firebasestorage.app",
            messagingSenderId: "1030272051491",
            appId: "1:1030272051491:web:4ec6ce21336cf511cac496",
            measurementId: "G-PR9E37ZYE2"
        };;

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;

    // Check auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('advertiserName').textContent = user.email;
        document.getElementById('advertiserId').textContent = user.uid;
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        loadRedeemedCoupons(); // Load their coupons
      } else {
        document.getElementById('loginSection').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
      }
    });

    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(err => alert('Login failed: ' + err.message));
    }

    function logout() {
      auth.signOut();
    }

    // üîë Load ONLY coupons where advertiserId == currentUser.uid
    async function loadRedeemedCoupons() {
      const tbody = document.getElementById('redeemedTableBody');
      tbody.innerHTML = '';
      
      try {
        const snapshot = await db
          .collection('redeemed_coupons')
          .where('advertiserId', '==', currentUser.uid)
          .orderBy('claimedAt', 'desc')
          .get();

        if (snapshot.empty) {
          document.getElementById('noDataMessage').classList.remove('hidden');
          document.getElementById('redeemedTable').classList.add('hidden');
          return;
        }

        document.getElementById('noDataMessage').classList.add('hidden');
        document.getElementById('redeemedTable').classList.remove('hidden');

        snapshot.forEach(doc => {
          const c = doc.data();
          const row = `<tr>
            <td>${c.couponCode || '‚Äî'}</td>
            <td>${c.customerId || '‚Äî'}</td>
            <td>${c.product || '‚Äî'}</td>
            <td>${c.location || '‚Äî'}</td>
            <td>${c.claimedAt?.toDate?.().toLocaleString() || c.claimedAt || '‚Äî'}</td>
            <td>${c.expiresAt?.toDate?.().toLocaleDateString() || c.expiresAt || '‚Äî'}</td>
          </tr>`;
          tbody.innerHTML += row;
        });
      } catch (err) {
        console.error("Error loading coupons:", err);
        alert("Failed to load redeemed coupons.");
      }
    }

    // üì§ Export to PDF (via print)
    function exportToPDF() {
      if (!confirm('Choose "Save as PDF" in the print dialog.')) return;
      const table = document.getElementById('redeemedTable').outerHTML;
      const win = window.open('', '', 'height=600,width=800');
      win.document.write(`
        <html><head><title>Redeemed Coupons</title>
        <style>
          body { font-family: Arial; }
          table { width: 100%; border-collapse: collapse; }
          th, td { border: 1px solid #000; padding: 8px; }
          th { background: #f0f0f0; }
        </style>
        </head><body>
        <h2>Redeemed Coupons for ${currentUser.email}</h2>
        ${table}
        </body></html>
      `);
      win.document.close();
      win.print();
    }

    // Other functions (unchanged logic)
    function showDashboard() {
      document.getElementById('validateSection').classList.add('hidden');
      document.getElementById('passwordSection').classList.add('hidden');
      document.getElementById('dashboardSection').classList.remove('hidden');
    }

    function hideDashboard() {
      document.getElementById('dashboardSection').classList.add('hidden');
      document.getElementById('validateSection').classList.remove('hidden');
    }

    function changePassword() {
      document.getElementById('validateSection').classList.add('hidden');
      document.getElementById('dashboardSection').classList.add('hidden');
      document.getElementById('passwordSection').classList.remove('hidden');
    }

    function cancelPasswordChange() {
      document.getElementById('passwordSection').classList.add('hidden');
      document.getElementById('validateSection').classList.remove('hidden');
    }

    function savePassword() {
      const pw = document.getElementById('newPassword').value;
      if (pw.length >= 6) {
        currentUser.updatePassword(pw)
          .then(() => alert('Password updated!'))
          .catch(err => alert('Error: ' + err.message));
        cancelPasswordChange();
      } else {
        alert('Password must be at least 6 characters.');
      }
    }

    function validateCoupon() {
      const code = document.getElementById('couponCode').value.trim();
      if (!code) return alert('Enter a coupon code.');

      // Simulate validation (in real app, check against active coupons in Firestore)
      document.getElementById('resultMessage').innerHTML = `
        ‚úÖ VALID COUPON<br>
        Product: Premium Coffee<br>
        Location: Downtown Cafe<br>
        Customer ID: CUST555<br>
        <button class="btn btn-primary" onclick="markAsUsed('${code}')">‚úÖ Mark as Used</button>
        <button class="btn" onclick="resetScanner()">üîÑ Scan Another</button>
      `;
      document.getElementById('resultMessage').classList.remove('hidden');
    }

    // ‚úÖ Save redeemed coupon to Firestore (linked to advertiser)
    async function markAsUsed(couponCode) {
      try {
        await db.collection('redeemed_coupons').add({
          couponCode: couponCode,
          advertiserId: currentUser.uid,
          customerId: 'CUST555', // ‚Üê from scan or input
          product: 'Premium Coffee',
          location: 'Downtown Cafe',
          claimedAt: firebase.firestore.FieldValue.serverTimestamp(),
          expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // +1 day
        });
        document.getElementById('resultMessage').innerHTML = '‚úÖ Coupon marked as used!';
        loadRedeemedCoupons(); // Refresh dashboard
      } catch (err) {
        console.error(err);
        alert('Failed to save redemption.');
      }
    }

    function resetScanner() {
      document.getElementById('couponCode').value = '';
      document.getElementById('resultMessage').classList.add('hidden');
    }
  </script>
</body>
</html>
