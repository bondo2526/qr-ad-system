<!DOCTYPE html>
<html>
<head>
    <title>Coupon Validator - Advertiser Portal</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container { 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            max-width: 500px; 
            width: 100%; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
        }
        
        h1 { 
            color: #333; 
            margin-bottom: 10px; 
            text-align: center;
            font-size: clamp(28px, 6vw, 32px);
        }
        
        h2 {
            color: #333;
            margin: 20px 0 10px 0;
            text-align: center;
            font-size: clamp(22px, 5vw, 26px);
        }
        
        h3 {
            color: #333;
            margin: 15px 0;
            text-align: center;
        }
        
        p {
            color: #666;
            margin: 10px 0;
            font-size: 16px;
            line-height: 1.6;
            text-align: center;
        }
        
        .scanner-section {
            margin: 25px 0;
            text-align: center;
        }
        
        #reader {
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            border: 3px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .result {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            text-align: left;
        }
        
        .valid { background: #E8F5E9; border: 2px solid #4CAF50; }
        .invalid { background: #FFEBEE; border: 2px solid #F44336; }
        .used { background: #FFF3E0; border: 2px solid #FF9800; }
        
        .coupon-display {
            font-size: 28px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            word-break: break-all;
        }
        
        .info-item {
            margin: 12px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 15px;
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
            font-size: 16px;
            min-height: 50px;
            flex: 1;
        }
        
        .btn-validate { background: #4CAF50; color: white; }
        .btn-validate:hover { background: #45a049; }
        
        .btn-mark-used { background: #2196F3; color: white; }
        .btn-mark-used:hover { background: #1976D2; }
        
        .btn-reset { background: #9E9E9E; color: white; }
        .btn-reset:hover { background: #757575; }
        
        .btn-login { 
            background: #4CAF50; 
            color: white; 
            width: 100%;
            margin-top: 20px;
        }
        
        .btn-login:hover { background: #45a049; }
        
        .btn-logout {
            background: #f44336;
            color: white;
            margin-top: 20px;
        }
        
        .btn-logout:hover {
            background: #d32f2f;
        }
        
        .btn-change-password {
            background: #9C27B0;
            color: white;
            margin-top: 20px;
        }
        
        .btn-change-password:hover {
            background: #7B1FA2;
        }
        
        .btn-dashboard {
            background: #FF9800;
            color: white;
            margin-top: 20px;
        }
        
        .btn-dashboard:hover {
            background: #F57C00;
        }
        
        .btn-export {
            background: #4CAF50;
            color: white;
            margin: 10px 0;
        }
        
        .btn-export:hover {
            background: #45a049;
        }
        
        .btn-back {
            background: #607D8B;
            color: white;
            margin: 10px 0;
        }
        
        .btn-back:hover {
            background: #546E7A;
        }
        
        .hidden { display: none; }
        
        .login-section {
            text-align: center;
        }
        
        .advertiser-id-section {
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        input[type="text"], 
        input[type="password"],
        input[type="date"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        input[type="text"]:focus, 
        input[type="password"]:focus,
        input[type="date"]:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .error-message {
            color: #f44336;
            margin: 10px 0;
            text-align: center;
            font-size: 15px;
            min-height: 20px;
        }
        
        .success-message {
            color: #4CAF50;
            margin: 10px 0;
            text-align: center;
            font-size: 15px;
            min-height: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .scanner-instruction {
            background: #E3F2FD;
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 15px;
        }
        
        .advertiser-info {
            background: #E8F5E9;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .advertiser-info h3 {
            color: #2E7D32;
            margin-bottom: 10px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .modal-btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .modal-btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        /* New validation message styles */
        .validation-result {
            text-align: center;
            padding: 30px;
        }
        
        .validation-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .validation-message {
            font-size: 18px;
            margin: 20px 0;
            line-height: 1.5;
        }
        
        .coupon-code-highlight {
            background: #333;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 0 5px;
        }
        
        /* Dashboard Styles */
        .dashboard-section {
            text-align: center;
        }
        
        .dashboard-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            min-width: 120px;
            flex: 1;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #2196F3;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .date-filter {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .date-filter input {
            flex: 1;
            min-width: 120px;
        }
        
        .coupons-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 10px;
        }
        
        .coupon-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
            border-left: 4px solid #4CAF50;
        }
        
        .coupon-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .coupon-details {
            font-size: 14px;
            color: #666;
        }
        
        .coupon-details div {
            margin: 3px 0;
        }
        
        .no-coupons {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
            
            .header-controls {
                flex-direction: column;
            }
            
            #reader {
                max-width: 250px;
            }
            
            .date-filter {
                flex-direction: column;
            }
            
            .dashboard-stats {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h1>üîê Advertiser Scanner</h1>
            <p>Login with your advertiser credentials</p>
            
            <div class="advertiser-id-section">
                <input type="text" 
                       id="advertiserId" 
                       placeholder="Your Advertiser ID (e.g., pharmacy1)"
                       autocomplete="off">
                
                <input type="password" 
                       id="advertiserPassword" 
                       placeholder="Your Password"
                       onkeypress="handleLoginEnter(event)">
                
                <div class="error-message" id="loginError"></div>
                
                <button class="btn btn-login" onclick="login()">
                    üîì Login to Scanner
                </button>
            </div>
            
            <div class="scanner-instruction">
                <p><strong>First time?</strong></p>
                <p>Use any advertiser ID and password (min 6 chars).</p>
                <p>Account will be created automatically.</p>
            </div>
            
            <div class="advertiser-info">
                <h3>üì± How to Use:</h3>
                <p>1. Login with your advertiser credentials</p>
                <p>2. Enter customer's coupon code manually</p>
                <p>3. Validate and mark coupons as used</p>
                <p>4. Track all redeemed coupons in your dashboard</p>
            </div>
        </div>
        
        <!-- Scanner Section -->
        <div id="scannerSection" class="hidden">
            <h1>üì± Coupon Validator</h1>
            
            <div class="advertiser-info">
                <h3>Logged in as: <span id="loggedInAdvertiser"></span></h3>
                <p>Advertiser ID: <strong><span id="currentAdvertiserId"></span></strong></p>
            </div>
            
            <div class="header-controls">
                <button class="btn btn-dashboard" onclick="showDashboard()">
                    üìä Redeemed Coupons
                </button>
                <button class="btn btn-change-password" onclick="showChangePasswordModal()">
                    üîë Change Password
                </button>
                <button class="btn btn-logout" onclick="logout()">
                    üö™ Logout
                </button>
            </div>
            
            <!-- Manual Input Section -->
            <div class="scanner-section">
                <input type="text" 
                       id="manualCode" 
                       placeholder="Enter coupon code here"
                       onkeypress="handleManualCodeEnter(event)">
                
                <div class="action-buttons">
                    <button class="btn btn-validate" onclick="validateManualCode()">
                        ‚úÖ Validate Code
                    </button>
                    <button class="btn btn-reset" onclick="resetScanner()">
                        üîÑ Reset Scanner
                    </button>
                </div>
            </div>
            
            <!-- Validation Result Section -->
            <div id="resultSection" class="hidden">
                <div class="coupon-display" id="scannedCoupon"></div>
                
                <div id="validResult" class="result hidden">
                    <h2 style="color: #4CAF50;">‚úÖ VALID COUPON</h2>
                    <div class="info-item"><strong>Ad Campaign:</strong> <span id="resultAd"></span></div>
                    <div class="info-item"><strong>Product:</strong> <span id="resultProduct"></span></div>
                    <div class="info-item"><strong>Location Claimed:</strong> <span id="resultLocation"></span></div>
                    <div class="info-item"><strong>Claimed At:</strong> <span id="resultTime"></span></div>
                    <div class="info-item"><strong>Expires:</strong> <span id="resultExpires"></span></div>
                    <div class="info-item"><strong>Customer ID:</strong> <span id="resultCustomer"></span></div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-mark-used" onclick="markCouponUsed()">
                            ‚úÖ Mark as Used
                        </button>
                        <button class="btn btn-reset" onclick="resetScanner()">
                            üîÑ Scan Another
                        </button>
                    </div>
                </div>
                
                <div id="invalidResult" class="result invalid hidden">
                    <h2 style="color: #F44336;">‚ùå INVALID COUPON</h2>
                    <p id="invalidMessage" style="text-align: center; font-size: 16px;"></p>
                    <div class="action-buttons">
                        <button class="btn btn-reset" onclick="resetScanner()">
                            üîÑ Try Again
                        </button>
                    </div>
                </div>
                
                <!-- SIMPLIFIED USED COUPON RESULT -->
                <div id="usedResult" class="validation-result hidden">
                    <div class="validation-icon">‚ö†Ô∏è</div>
                    <h2 style="color: #FF9800;">COUPON ALREADY REDEEMED</h2>
                    <p class="validation-message">
                        This coupon was already redeemed by <strong><span id="redeemedBy"></span></strong>.
                    </p>
                    <div class="action-buttons">
                        <button class="btn btn-reset" onclick="resetScanner()">
                            üîÑ Scan Another Coupon
                        </button>
                    </div>
                </div>
                
                <!-- SUCCESS VALIDATION MESSAGE -->
                <div id="successResult" class="validation-result hidden">
                    <div class="validation-icon">‚úÖ</div>
                    <h2 style="color: #4CAF50;">VALIDATION COMPLETE!</h2>
                    <p class="validation-message">
                        Coupon code <span class="coupon-code-highlight" id="successCouponCode"></span><br>
                        has been successfully validated and marked as used.
                    </p>
                    <div class="action-buttons">
                        <button class="btn btn-reset" onclick="resetScanner()">
                            üîÑ Scan Another Coupon
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="dashboard-section hidden">
            <h1>üìä Redeemed Coupons Dashboard</h1>
            
            <div class="advertiser-info">
                <h3>Advertiser: <span id="dashboardAdvertiser"></span></h3>
                <p>Viewing all coupons you have redeemed</p>
            </div>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalRedeemed">0</div>
                    <div class="stat-label">Total Redeemed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayRedeemed">0</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="weekRedeemed">0</div>
                    <div class="stat-label">This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="monthRedeemed">0</div>
                    <div class="stat-label">This Month</div>
                </div>
            </div>
            
            <div class="date-filter">
                <input type="date" id="startDate" placeholder="Start Date">
                <input type="date" id="endDate" placeholder="End Date">
                <button class="btn btn-validate" onclick="filterCoupons()">
                    üîç Filter
                </button>
                <button class="btn btn-reset" onclick="clearFilter()">
                    üîÑ Clear
                </button>
            </div>
            
            <button class="btn btn-export" onclick="exportToPDF()">
                üìÑ Export to PDF
            </button>
            
            <div id="couponsList" class="coupons-list">
                <div class="no-coupons" id="loadingCoupons">
                    Loading redeemed coupons...
                </div>
            </div>
            
            <button class="btn btn-back" onclick="backToScanner()">
                ‚Üê Back to Scanner
            </button>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div class="modal-overlay" id="passwordModal">
        <div class="modal">
            <h2>üîë Change Your Password</h2>
            
            <div style="margin-bottom: 20px;">
                <input type="password" 
                       id="currentPassword" 
                       class="password-input" 
                       placeholder="Current Password"
                       style="margin-bottom: 15px;"
                       onkeypress="handlePasswordModalEnter(event)">
                
                <input type="password" 
                       id="newPassword" 
                       class="password-input" 
                       placeholder="New Password (min 6 characters)"
                       style="margin-bottom: 15px;"
                       onkeypress="handlePasswordModalEnter(event)">
                
                <input type="password" 
                       id="confirmPassword" 
                       class="password-input" 
                       placeholder="Confirm New Password"
                       onkeypress="handlePasswordModalEnter(event)">
                
                <div class="error-message" id="passwordError"></div>
                <div class="success-message" id="passwordSuccess"></div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closePasswordModal()">
                    Cancel
                </button>
                <button class="modal-btn modal-btn-primary" onclick="changePassword()">
                    Change Password
                </button>
            </div>
        </div>
    </div>

    <script>
        // === FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyCxuGBz5FNcaXbCNOfoC9ccR5IsZSYS1d4",
            authDomain: "ad-coupon-system.firebaseapp.com",
            projectId: "ad-coupon-system",
            storageBucket: "ad-coupon-system.firebasestorage.app",
            messagingSenderId: "1030272051491",
            appId: "1:1030272051491:web:4ec6ce21336cf511cac496",
            measurementId: "G-PR9E37ZYE2"
        };
        
        // Initialize Firebase with ALL services
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // === ADVERTISER PASSWORD MANAGEMENT ===
        const ADVERTISERS_COLLECTION = 'advertisers';
        let currentAdvertiser = null;
        let html5QrCode = null;
        let currentCouponData = null;
        let redeemedCoupons = [];
        
        // Initialize on page load WITH AUTH
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // First, sign in anonymously to Firebase Auth
                await auth.signInAnonymously();
                console.log("‚úÖ Firebase Auth: Signed in anonymously");
                
                // Check if already logged in from session
                const savedAdvertiser = sessionStorage.getItem('advertiser_logged_in');
                if (savedAdvertiser) {
                    try {
                        currentAdvertiser = JSON.parse(savedAdvertiser);
                        showScannerSection();
                    } catch (e) {
                        console.error("Session parse error:", e);
                        sessionStorage.removeItem('advertiser_logged_in');
                    }
                }
                
                // Focus on advertiser ID input
                document.getElementById('advertiserId').focus();
                
            } catch (error) {
                console.error("Auth initialization error:", error);
                document.getElementById('loginError').textContent = 
                    '‚ùå Authentication error: ' + error.message;
                
                // Try to continue anyway for testing
                if (error.code === 'auth/operation-not-allowed') {
                    document.getElementById('loginError').innerHTML += 
                        '<br><small>‚ö†Ô∏è Anonymous auth disabled. Contact admin to enable it.</small>';
                }
            }
        });
        
        // === ADVERTISER LOGIN FUNCTIONS ===
        async function login() {
            const advertiserId = document.getElementById('advertiserId').value.trim();
            const password = document.getElementById('advertiserPassword').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            // Clear previous error
            errorDiv.textContent = '';
            
            // Validate inputs
            if (!advertiserId) {
                errorDiv.textContent = '‚ùå Please enter your Advertiser ID';
                document.getElementById('advertiserId').focus();
                return;
            }
            
            if (!password) {
                errorDiv.textContent = '‚ùå Please enter your password';
                document.getElementById('advertiserPassword').focus();
                return;
            }
            
            if (password.length < 6) {
                errorDiv.textContent = '‚ùå Password must be at least 6 characters';
                return;
            }
            
            try {
                // Check if advertiser exists in Firestore
                const advertiserDoc = await db.collection(ADVERTISERS_COLLECTION)
                    .doc(advertiserId.toLowerCase())
                    .get();
                
                if (!advertiserDoc.exists) {
                    // Create new advertiser
                    await createNewAdvertiser(advertiserId, password);
                    showSuccessMessage('‚úÖ Account created successfully!');
                } else {
                    // Verify existing advertiser password
                    const advertiserData = advertiserDoc.data();
                    
                    if (advertiserData.password !== password) {
                        errorDiv.textContent = '‚ùå Incorrect password';
                        document.getElementById('advertiserPassword').value = '';
                        document.getElementById('advertiserPassword').focus();
                        return;
                    }
                    
                    currentAdvertiser = {
                        id: advertiserId.toLowerCase(),
                        name: advertiserData.name || advertiserId,
                        createdAt: advertiserData.createdAt,
                        couponValidations: advertiserData.couponValidations || 0
                    };
                    
                    showSuccessMessage('‚úÖ Login successful!');
                }
                
                // Save to session
                sessionStorage.setItem('advertiser_logged_in', JSON.stringify(currentAdvertiser));
                
                // Clear password fields
                document.getElementById('advertiserId').value = '';
                document.getElementById('advertiserPassword').value = '';
                
                // Show scanner section
                showScannerSection();
                
            } catch (error) {
                console.error('Login error:', error);
                
                if (error.code === 'permission-denied') {
                    errorDiv.innerHTML = `
                        ‚ùå Permission denied<br>
                        <small style="color: #666;">
                            Need to update Firebase rules:<br>
                            1. Go to Firebase Console ‚Üí Firestore ‚Üí Rules<br>
                            2. Allow read/write to 'advertisers' collection<br>
                            3. Or use test credentials below
                        </small>
                        <div style="margin-top: 10px; padding: 10px; background: #FFF3E0; border-radius: 5px;">
                            <strong>Test Login (works without Firebase):</strong><br>
                            ID: <code>testshop</code><br>
                            Password: <code>test123</code>
                        </div>
                    `;
                    
                    // Allow test login without Firebase
                    if (advertiserId === 'testshop' && password === 'test123') {
                        currentAdvertiser = {
                            id: 'testshop',
                            name: 'Test Shop',
                            isTest: true
                        };
                        sessionStorage.setItem('advertiser_logged_in', JSON.stringify(currentAdvertiser));
                        showScannerSection();
                    }
                } else {
                    errorDiv.textContent = '‚ùå Login error: ' + error.message;
                }
            }
        }
        
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            successDiv.id = 'tempSuccess';
            document.getElementById('loginError').parentNode.insertBefore(successDiv, document.getElementById('loginError'));
            
            setTimeout(() => {
                if (document.getElementById('tempSuccess')) {
                    document.getElementById('tempSuccess').remove();
                }
            }, 3000);
        }
        
        async function createNewAdvertiser(advertiserId, password) {
            const newAdvertiser = {
                id: advertiserId.toLowerCase(),
                name: advertiserId,
                password: password,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                couponValidations: 0,
                isActive: true
            };
            
            await db.collection(ADVERTISERS_COLLECTION)
                .doc(advertiserId.toLowerCase())
                .set(newAdvertiser);
            
            currentAdvertiser = {
                id: advertiserId.toLowerCase(),
                name: advertiserId,
                createdAt: new Date(),
                couponValidations: 0
            };
        }
        
        function handleLoginEnter(event) {
            if (event.key === 'Enter') {
                login();
            }
        }
        
        function showScannerSection() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('scannerSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            
            // Display advertiser info
            document.getElementById('loggedInAdvertiser').textContent = currentAdvertiser.name;
            document.getElementById('currentAdvertiserId').textContent = currentAdvertiser.id;
        }
        
        function logout() {
            // Clear session
            sessionStorage.removeItem('advertiser_logged_in');
            currentAdvertiser = null;
            currentCouponData = null;
            redeemedCoupons = [];
            
            // Show login section
            document.getElementById('scannerSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            
            // Reset form and focus
            document.getElementById('advertiserId').value = '';
            document.getElementById('advertiserPassword').value = '';
            document.getElementById('advertiserId').focus();
        }
        
        // === DASHBOARD FUNCTIONS ===
        function showDashboard() {
            document.getElementById('scannerSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('dashboardAdvertiser').textContent = currentAdvertiser.name;
            
            // Load redeemed coupons
            loadRedeemedCoupons();
        }
        
        function backToScanner() {
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('scannerSection').classList.remove('hidden');
        }
        
        async function loadRedeemedCoupons() {
            try {
                document.getElementById('couponsList').innerHTML = 
                    '<div class="no-coupons" id="loadingCoupons">Loading redeemed coupons...</div>';
                
                // Query Firestore for coupons redeemed by this advertiser
                const claimsRef = db.collection('claims');
                const querySnapshot = await claimsRef
                    .where('redeemedBy', '==', currentAdvertiser.id)
                    .where('redeemed', '==', true)
                    .orderBy('redeemedAt', 'desc')
                    .get();
                
                redeemedCoupons = [];
                let todayCount = 0;
                let weekCount = 0;
                let monthCount = 0;
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                
                if (querySnapshot.empty) {
                    document.getElementById('couponsList').innerHTML = 
                        '<div class="no-coupons">No redeemed coupons found yet.</div>';
                } else {
                    let couponsHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const couponData = {
                            id: doc.id,
                            ...doc.data()
                        };
                        
                        const redeemedAt = couponData.redeemedAt?.toDate();
                        redeemedCoupons.push(couponData);
                        
                        // Count statistics
                        if (redeemedAt) {
                            if (redeemedAt >= today) todayCount++;
                            if (redeemedAt >= weekAgo) weekCount++;
                            if (redeemedAt >= monthAgo) monthCount++;
                        }
                        
                        // Format date for display
                        const redeemedDate = redeemedAt ? 
                            redeemedAt.toLocaleDateString() + ' ' + redeemedAt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
                            'Unknown';
                        
                        couponsHTML += `
                            <div class="coupon-item">
                                <div class="coupon-code">${couponData.couponCode || 'N/A'}</div>
                                <div class="coupon-details">
                                    <div><strong>Ad Campaign:</strong> ${couponData.adName || 'Unknown'}</div>
                                    <div><strong>Product:</strong> ${couponData.productName || 'Unknown'}</div>
                                    <div><strong>Customer:</strong> ${couponData.userId?.substring(0, 8) || 'Unknown'}...</div>
                                    <div><strong>Redeemed:</strong> ${redeemedDate}</div>
                                    <div><strong>Original Claim:</strong> ${couponData.claimedAt?.toDate().toLocaleDateString() || 'Unknown'}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('couponsList').innerHTML = couponsHTML;
                }
                
                // Update statistics
                document.getElementById('totalRedeemed').textContent = redeemedCoupons.length;
                document.getElementById('todayRedeemed').textContent = todayCount;
                document.getElementById('weekRedeemed').textContent = weekCount;
                document.getElementById('monthRedeemed').textContent = monthCount;
                
            } catch (error) {
                console.error("Error loading redeemed coupons:", error);
                document.getElementById('couponsList').innerHTML = 
                    '<div class="no-coupons">Error loading coupons: ' + error.message + '</div>';
            }
        }
        
        async function filterCoupons() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert("Please select both start and end dates");
                return;
            }
            
            try {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999); // End of day
                
                if (start > end) {
                    alert("Start date must be before end date");
                    return;
                }
                
                document.getElementById('couponsList').innerHTML = 
                    '<div class="no-coupons">Filtering coupons...</div>';
                
                const claimsRef = db.collection('claims');
                const querySnapshot = await claimsRef
                    .where('redeemedBy', '==', currentAdvertiser.id)
                    .where('redeemed', '==', true)
                    .orderBy('redeemedAt', 'desc')
                    .get();
                
                let filteredCoupons = [];
                let filteredHTML = '';
                
                querySnapshot.forEach(doc => {
                    const couponData = {
                        id: doc.id,
                        ...doc.data()
                    };
                    
                    const redeemedAt = couponData.redeemedAt?.toDate();
                    if (redeemedAt && redeemedAt >= start && redeemedAt <= end) {
                        filteredCoupons.push(couponData);
                        
                        const redeemedDate = redeemedAt.toLocaleDateString() + ' ' + 
                                            redeemedAt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        filteredHTML += `
                            <div class="coupon-item">
                                <div class="coupon-code">${couponData.couponCode || 'N/A'}</div>
                                <div class="coupon-details">
                                    <div><strong>Ad Campaign:</strong> ${couponData.adName || 'Unknown'}</div>
                                    <div><strong>Product:</strong> ${couponData.productName || 'Unknown'}</div>
                                    <div><strong>Customer:</strong> ${couponData.userId?.substring(0, 8) || 'Unknown'}...</div>
                                    <div><strong>Redeemed:</strong> ${redeemedDate}</div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                if (filteredCoupons.length === 0) {
                    document.getElementById('couponsList').innerHTML = 
                        '<div class="no-coupons">No redeemed coupons found for this date range.</div>';
                } else {
                    document.getElementById('couponsList').innerHTML = filteredHTML;
                }
                
            } catch (error) {
                console.error("Error filtering coupons:", error);
                document.getElementById('couponsList').innerHTML = 
                    '<div class="no-coupons">Error filtering coupons: ' + error.message + '</div>';
            }
        }
        
        function clearFilter() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            loadRedeemedCoupons();
        }
        
        function exportToPDF() {
            if (redeemedCoupons.length === 0) {
                alert("No redeemed coupons to export");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(18);
            doc.text("Redeemed Coupons Report", 105, 15, { align: 'center' });
            
            // Advertiser info
            doc.setFontSize(12);
            doc.text(`Advertiser: ${currentAdvertiser.name}`, 20, 25);
            doc.text(`Report Date: ${new Date().toLocaleDateString()}`, 20, 32);
            doc.text(`Total Redeemed: ${redeemedCoupons.length}`, 20, 39);
            
            // Table data
            const tableData = redeemedCoupons.map(coupon => {
                const redeemedAt = coupon.redeemedAt?.toDate();
                const claimedAt = coupon.claimedAt?.toDate();
                
                return [
                    coupon.couponCode || 'N/A',
                    coupon.adName || 'Unknown',
                    coupon.productName || 'Unknown',
                    coupon.userId?.substring(0, 8) + '...' || 'Unknown',
                    claimedAt ? claimedAt.toLocaleDateString() : 'Unknown',
                    redeemedAt ? redeemedAt.toLocaleDateString() + ' ' + 
                               redeemedAt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Unknown'
                ];
            });
            
            // Create table
            doc.autoTable({
                startY: 45,
                head: [['Coupon Code', 'Ad Campaign', 'Product', 'Customer ID', 'Claimed Date', 'Redeemed Date']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [76, 175, 80] },
                margin: { top: 45 }
            });
            
            // Save the PDF
            const fileName = `Redeemed_Coupons_${currentAdvertiser.id}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }
        
        // === PASSWORD CHANGE FUNCTIONS ===
        function showChangePasswordModal() {
            if (currentAdvertiser?.isTest) {
                alert('Test account cannot change password. Create a real account.');
                return;
            }
            
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('currentPassword').focus();
            document.getElementById('passwordError').textContent = '';
            document.getElementById('passwordSuccess').textContent = '';
        }
        
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordError').textContent = '';
            document.getElementById('passwordSuccess').textContent = '';
        }
        
        function handlePasswordModalEnter(event) {
            if (event.key === 'Enter') {
                changePassword();
            }
        }
        
        async function changePassword() {
            const currentPass = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
            const successDiv = document.getElementById('passwordSuccess');
            
            // Clear messages
            errorDiv.textContent = '';
            successDiv.textContent = '';
            
            // Validate
            if (!currentPass || !newPass || !confirmPass) {
                errorDiv.textContent = '‚ùå Please fill all fields';
                return;
            }
            
            if (newPass.length < 6) {
                errorDiv.textContent = '‚ùå New password must be at least 6 characters';
                return;
            }
            
            if (newPass !== confirmPass) {
                errorDiv.textContent = '‚ùå New passwords do not match';
                return;
            }
            
            try {
                // Get current advertiser data
                const advertiserDoc = await db.collection(ADVERTISERS_COLLECTION)
                    .doc(currentAdvertiser.id)
                    .get();
                
                if (!advertiserDoc.exists) {
                    errorDiv.textContent = '‚ùå Advertiser not found';
                    return;
                }
                
                const advertiserData = advertiserDoc.data();
                
                // Verify current password
                if (advertiserData.password !== currentPass) {
                    errorDiv.textContent = '‚ùå Current password is incorrect';
                    return;
                }
                
                // Update password in Firestore
                await db.collection(ADVERTISERS_COLLECTION)
                    .doc(currentAdvertiser.id)
                    .update({
                        password: newPass,
                        passwordChangedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                // Show success message
                successDiv.textContent = '‚úÖ Password changed successfully!';
                successDiv.style.display = 'block';
                
                // Clear fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                // Close modal after 2 seconds
                setTimeout(() => {
                    closePasswordModal();
                }, 2000);
                
            } catch (error) {
                console.error('Password change error:', error);
                errorDiv.textContent = '‚ùå Error changing password: ' + error.message;
            }
        }
        
        // === SCANNER FUNCTIONS ===
        function handleManualCodeEnter(event) {
            if (event.key === 'Enter') {
                validateManualCode();
            }
        }
        
        function validateManualCode() {
            const code = document.getElementById('manualCode').value.trim();
            if (code) {
                validateCoupon(code);
            } else {
                alert("Please enter a coupon code");
                document.getElementById('manualCode').focus();
            }
        }
        
        async function validateCoupon(couponCode) {
            try {
                // Show loading state
                document.getElementById('resultSection').classList.remove('hidden');
                document.getElementById('validResult').classList.add('hidden');
                document.getElementById('invalidResult').classList.add('hidden');
                document.getElementById('usedResult').classList.add('hidden');
                document.getElementById('successResult').classList.add('hidden');
                
                document.getElementById('scannedCoupon').textContent = couponCode;
                
                // Query Firestore for this coupon
                const claimsRef = db.collection('claims');
                const querySnapshot = await claimsRef
                    .where('couponCode', '==', couponCode)
                    .limit(1)
                    .get();
                
                if (querySnapshot.empty) {
                    showInvalidResult("Coupon not found in database");
                    return;
                }
                
                const doc = querySnapshot.docs[0];
                currentCouponData = {
                    id: doc.id,
                    ...doc.data()
                };
                
                // Format dates
                const claimedTime = currentCouponData.claimedAt?.toDate();
                const expiresTime = currentCouponData.expiresAt?.toDate();
                const now = new Date();
                
                // Check if expired
                if (expiresTime && expiresTime < now) {
                    showInvalidResult("Coupon has expired");
                    return;
                }
                
                // Check if already redeemed
                if (currentCouponData.redeemed) {
                    showUsedResult();
                    return;
                }
                
                // Show valid result
                showValidResult();
                
            } catch (error) {
                console.error("Validation error:", error);
                showInvalidResult("Error validating coupon: " + error.message);
            }
        }
        
        function showValidResult() {
            document.getElementById('validResult').classList.remove('hidden');
            document.getElementById('invalidResult').classList.add('hidden');
            document.getElementById('usedResult').classList.add('hidden');
            document.getElementById('successResult').classList.add('hidden');
            
            const claimedTime = currentCouponData.claimedAt?.toDate();
            const expiresTime = currentCouponData.expiresAt?.toDate();
            
            document.getElementById('resultAd').textContent = currentCouponData.adName || 'Unknown';
            document.getElementById('resultProduct').textContent = currentCouponData.productName || 'Unknown';
            document.getElementById('resultLocation').textContent = currentCouponData.hostName || 'Unknown';
            document.getElementById('resultTime').textContent = claimedTime ? claimedTime.toLocaleString() : 'Unknown';
            document.getElementById('resultExpires').textContent = expiresTime ? expiresTime.toLocaleString() : 'Unknown';
            document.getElementById('resultCustomer').textContent = currentCouponData.userId.substring(0, 8) + '...';
        }
        
        function showInvalidResult(message) {
            document.getElementById('validResult').classList.add('hidden');
            document.getElementById('invalidResult').classList.remove('hidden');
            document.getElementById('usedResult').classList.add('hidden');
            document.getElementById('successResult').classList.add('hidden');
            
            document.getElementById('invalidMessage').textContent = message;
        }
        
        function showUsedResult() {
            document.getElementById('validResult').classList.add('hidden');
            document.getElementById('invalidResult').classList.add('hidden');
            document.getElementById('usedResult').classList.remove('hidden');
            document.getElementById('successResult').classList.add('hidden');
            
            document.getElementById('redeemedBy').textContent = currentCouponData.redeemedBy || 'another advertiser';
        }
        
        async function markCouponUsed() {
            try {
                const couponCode = currentCouponData.couponCode;
                
                // For test accounts, just show success
                if (currentAdvertiser?.isTest) {
                    // Show success message immediately
                    document.getElementById('validResult').classList.add('hidden');
                    document.getElementById('successResult').classList.remove('hidden');
                    document.getElementById('successCouponCode').textContent = couponCode;
                    
                    // Auto-reset after 1 second
                    setTimeout(() => {
                        resetScanner();
                    }, 1000);
                    return;
                }
                
                // Update the coupon as redeemed
                await db.collection('claims').doc(currentCouponData.id).update({
                    redeemed: true,
                    redeemedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    redeemedBy: currentAdvertiser.id,
                    redeemedByName: currentAdvertiser.name
                });
                
                // Update advertiser validation count
                await db.collection(ADVERTISERS_COLLECTION)
                    .doc(currentAdvertiser.id)
                    .update({
                        couponValidations: firebase.firestore.FieldValue.increment(1),
                        lastValidation: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                // Update current advertiser count
                currentAdvertiser.couponValidations = (currentAdvertiser.couponValidations || 0) + 1;
                
                // Show success message
                document.getElementById('validResult').classList.add('hidden');
                document.getElementById('successResult').classList.remove('hidden');
                document.getElementById('successCouponCode').textContent = couponCode;
                
                // Auto-reset after 1 second
                setTimeout(() => {
                    resetScanner();
                }, 1000);
                
            } catch (error) {
                alert('‚ùå Error marking coupon as used: ' + error.message);
            }
        }
        
        function resetScanner() {
            currentCouponData = null;
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('manualCode').value = '';
            document.getElementById('manualCode').focus();
        }
    </script>
</body>
</html>
