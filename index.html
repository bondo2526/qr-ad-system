<!DOCTYPE html>
<html>
<head>
    <title>Claim Your Coupon</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script> 
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
   
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        
        /* Body with dynamic backgrounds */
        body { 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px;
            transition: background 0.5s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Success background (green) */
        body.success-bg {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%) !important;
        }
        
        /* Blocked/Already claimed background (red) */
        body.blocked-bg {
            background: linear-gradient(135deg, #f44336 0%, #c62828 100%) !important;
        }
        
        .container { 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            max-width: 500px; 
            width: 100%; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
        }
        
        .success { color: #2E7D32; }
        .blocked { color: #C62828; }
        
        .coupon { 
            font-size: 42px; 
            font-weight: bold; 
            color: #2E7D32; 
            margin: 20px 0; 
            font-family: 'Courier New', monospace; 
            background: #E8F5E9; 
            padding: 15px; 
            border-radius: 10px; 
            border: 2px dashed #4CAF50; 
            text-align: center;
            word-break: break-all;
            font-size: clamp(32px, 6vw, 42px); /* Responsive font */
        }
        
        .coupon-blocked {
            font-size: 36px;
            font-weight: bold;
            color: #c62828;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            background: #FFEBEE;
            padding: 12px;
            border-radius: 8px;
            border: 2px dashed #c62828;
            text-align: center;
            word-break: break-all;
            font-size: clamp(28px, 5vw, 36px); /* Responsive font */
        }
        
        .info { 
            background: #E3F2FD; 
            padding: 15px; 
            border-radius: 10px; 
            margin: 20px 0; 
            font-size: 16px; /* Larger font */
            line-height: 1.6;
        }
        
        .info.blocked-info { 
            background: #FFEBEE; 
            border-left: 4px solid #c62828;
        }
        
        .info.warning-info { 
            background: #FFF3E0; 
            border-left: 4px solid #FF9800;
        }
        
        .countdown { 
            font-size: 28px; /* Larger font */
            font-weight: bold; 
            color: #E65100; 
            margin: 20px 0; 
            text-align: center;
            font-size: clamp(24px, 5vw, 28px); /* Responsive */
        }
        
        .loading { 
            text-align: center; 
            padding: 40px; 
        }
        
        .spinner { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #667eea; 
            border-radius: 50%; 
            width: 50px; /* Larger spinner */
            height: 50px;
            animation: spin 1s linear infinite; 
            margin: 0 auto 20px; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .hidden { display: none; }
        
        h1 { 
            margin-bottom: 15px; 
            text-align: center; 
            font-size: clamp(28px, 7vw, 36px); /* Responsive heading */
        }
        h2 { 
            color: #333; 
            margin: 15px 0; 
            text-align: center;
            font-size: clamp(22px, 5vw, 28px);
        }
        h3 { 
            color: #555; 
            margin: 15px 0; 
            text-align: center;
            font-size: clamp(18px, 4vw, 22px);
        }
        p { 
            margin: 12px 0; 
            color: #555; 
            font-size: 16px; /* Larger font */
            line-height: 1.6;
        }
        
        .instruction-box {
            background: #F5F5F5;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 16px;
        }
        
        .instruction-box h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .screenshot-instruction {
            background: #FFF8E1;
            border: 2px dashed #FFB300;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            color: #E65100;
            font-size: 18px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 14px 24px; /* Larger button */
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px; /* Larger font */
            flex: 1;
            min-height: 50px;
        }
        
        button:hover {
            background: #1976D2;
        }
        
        button.secondary {
            background: #757575;
        }
        
        button.secondary:hover {
            background: #616161;
        }
        
        .coupon-section {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #F9F9F9;
            border-radius: 10px;
        }
        
        /* QR Code Styles */
        .qr-container {
            text-align: center;
            margin: 25px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #E0E0E0;
        }
        
        .qr-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .qr-subtitle {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .qr-code-canvas {
            display: inline-block;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin: 10px auto;
            border: 1px solid #ddd;
        }
        
        .qr-instruction {
            background: #E8F5E9;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            font-size: 14px;
            color: #2E7D32;
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .coupon, .coupon-blocked {
                font-size: 28px;
                padding: 12px;
            }
            
            h1 {
                font-size: 28px;
            }
            
            h2 {
                font-size: 22px;
            }
            
            .info {
                padding: 12px;
                font-size: 15px;
            }
        }
        
        strong {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="font-size: 18px;">Loading your coupon...</p>
        </div>
        
        <!-- Success -->
        <div id="success" class="hidden">
            <h1 class="success">‚úÖ Coupon Claimed!</h1>
            <h2 id="adName"></h2>
            <p style="text-align: center;"><strong>Product:</strong> <span id="productName"></span></p>
            <p style="text-align: center;"><strong>Location:</strong> <span id="hostName"></span></p>
            
            <div class="coupon-section">
                <div class="coupon" id="couponCode"></div>
                <p style="text-align: center; font-weight: bold; margin-top: 10px; font-size: 18px;">Show this code at checkout</p>
            </div>
            
            <!-- QR Code for Success -->
            <div class="qr-container">
                <div class="qr-title">üì± Quick Scan QR Code</div>
                <p style="color: #666; margin-bottom: 15px;">Advertiser can scan this directly:</p>
                <div id="qrcode" class="qr-code-canvas"></div>
                <div class="qr-subtitle">Scan with advertiser's validator app</div>
                <div class="qr-instruction">
                    ‚úÖ Faster validation<br>
                    ‚úÖ No manual code entry needed
                </div>
            </div>
            
            <div class="screenshot-instruction">
                üì∏ TAKE A SCREENSHOT NOW!<br>
                This page will not be available again
            </div>
            
            <div class="info">
                <p><strong>‚úÖ Valid:</strong> 24 hours from now</p>
                <p><strong>‚ö†Ô∏è Limit:</strong> 1 coupon per ad per day</p>
                <p><strong>üïí Claimed at:</strong> <span id="claimTime"></span></p>
                <p><strong>üìç Location:</strong> <span id="locationName"></span></p>
            </div>
            
            <div class="info warning-info">
                <p><strong>Note:</strong> You cannot claim <strong>this same ad</strong> at any other location today.</p>
                <p>You CAN claim <strong>different ads</strong> at any location.</p>
            </div>
            
            <div class="instruction-box">
                <h4>How to Use:</h4>
                <p>1. Take screenshot of QR code above</p>
                <p>2. Show screenshot at checkout</p>
                <p>3. Advertiser scans QR code to validate</p>
            </div>
        </div>
        
        <!-- Blocked -->
        <div id="blocked" class="hidden">
            <h1 class="blocked">‚õî Already Claimed</h1>
            <h3 id="blockedAdName"></h3>
            
            <div class="coupon-section">
                <p style="font-weight: bold; color: #333; margin-bottom: 10px; font-size: 18px;">Your previously claimed coupon:</p>
                <div class="coupon-blocked" id="blockedCouponCode"></div>
                <p style="color: #666; font-size: 16px; margin-top: 5px;">Use this code at checkout</p>
            </div>
            
            <!-- QR Code for Blocked/Already Claimed -->
            <div class="qr-container">
                <div class="qr-title">üì± Your Coupon QR Code</div>
                <p style="color: #666; margin-bottom: 15px;">Advertiser can scan this directly:</p>
                <div id="blockedQrcode" class="qr-code-canvas"></div>
                <div class="qr-subtitle">Scan with advertiser's validator app</div>
                <div class="qr-instruction">
                    ‚úÖ Present this QR at checkout<br>
                    ‚úÖ Advertiser scans to validate
                </div>
            </div>
            
            <div class="info blocked-info">
                <p>You've already claimed <strong>this ad</strong> today.</p>
                <p><strong>Product:</strong> <span id="blockedProduct"></span></p>
                <p><strong>Location Claimed:</strong> <span id="blockedLocation"></span></p>
                <p><strong>Claimed at:</strong> <span id="blockedTime"></span></p>
                <p><strong>Status:</strong> <span id="blockedStatus">Available for use</span></p>
            </div>
            
            <div class="countdown" id="countdown"></div>
            
            <div class="screenshot-instruction">
                üì∏ Need a screenshot? Take one now!<br>
                You won't be able to see this code again
            </div>
            
            <div class="info">
                <p><strong>Coupon Rules:</strong></p>
                <p>‚úÖ <strong>This coupon is valid</strong> for 24 hours from claim time</p>
                <p>‚úÖ Show QR code at checkout to advertiser</p>
                <p>‚ùå <strong>Cannot claim same ad</strong> again until tomorrow</p>
                <p>‚úÖ You CAN claim <strong>different ads/products</strong></p>
            </div>
            
            <div class="action-buttons">
                <button onclick="closePage()">Close Page</button>
                <button class="secondary" onclick="copyCouponCode()">Copy Code</button>
            </div>
        </div>
        
        <!-- Error -->
        <div id="error" class="hidden">
            <h1 style="color: #FF5722;">‚ùå Error</h1>
            <p id="errorMessage" style="text-align: center; font-size: 18px;"></p>
            <button onclick="location.reload()">
                Try Again
            </button>
        </div>
    </div>

    <script>
        // === CONFIGURATION ===
        const CONFIG = {
            BLOCK_HOURS: 24,
            MAX_CLAIMS_PER_AD_PER_DAY: 1
        };

        // === FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyCxuGBz5FNcaXbCNOfoC9ccR5IsZSYS1d4",
            authDomain: "ad-coupon-system.firebaseapp.com",
            projectId: "ad-coupon-system",
            storageBucket: "ad-coupon-system.firebasestorage.app",
            messagingSenderId: "1030272051491",
            appId: "1:1030272051491:web:4ec6ce21336cf511cac496",
            measurementId: "G-PR9E37ZYE2"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Global variables
        let currentUser = null;
        let currentAd = null;
        let currentProduct = null;
        let currentHost = null;
        let userFingerprint = null;
        let existingCouponCode = null;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                currentAd = urlParams.get('ad') || 'unknown_ad';
                currentProduct = urlParams.get('product') || 'unknown_product';
                currentHost = urlParams.get('host') || 'unknown_location';
                
                // Decode names for display
                const displayAdName = decodeURIComponent(currentAd).replace(/_/g, ' ');
                const displayProductName = decodeURIComponent(currentProduct).replace(/_/g, ' ');
                const displayHostName = decodeURIComponent(currentHost).replace(/_/g, ' ');
                
                // Update display elements
                document.getElementById('adName').textContent = displayAdName;
                document.getElementById('productName').textContent = displayProductName;
                document.getElementById('hostName').textContent = displayHostName;
                document.getElementById('locationName').textContent = displayHostName;
                document.getElementById('blockedAdName').textContent = displayAdName;
                document.getElementById('blockedProduct').textContent = displayProductName;
                document.getElementById('blockedLocation').textContent = displayHostName;
                
                // Initialize Firebase Auth (anonymous)
                const userCredential = await auth.signInAnonymously();
                currentUser = userCredential.user;
                
                // Generate user fingerprint
                userFingerprint = await generateUserFingerprint();
                
                // Check if user already claimed this ad TODAY
                await checkIfAlreadyClaimed();
                
            } catch (error) {
                showError('Initialization error: ' + error.message);
            }
        });
        
        // === CORE LOGIC ===
        async function checkIfAlreadyClaimed() {
            try {
                const twentyFourHoursAgo = new Date();
                twentyFourHoursAgo.setHours(twentyFourHoursAgo.getHours() - 24);
                
                // Query by user fingerprint
                const claimsRef = db.collection('claims');
                const querySnapshot = await claimsRef
                    .where('userFingerprint', '==', userFingerprint)
                    .orderBy('claimedAt', 'desc')
                    .limit(10)
                    .get();
                
                let alreadyClaimed = false;
                let existingClaim = null;
                
                querySnapshot.forEach(doc => {
                    const claim = doc.data();
                    const claimTime = claim.claimedAt?.toDate();
                    
                    // Check conditions: same ad AND same product AND within 24h
                    const isSameAd = claim.adId === currentAd;
                    const isSameProduct = claim.productId === currentProduct;
                    const isWithin24h = claimTime >= twentyFourHoursAgo;
                    
                    if (isSameAd && isSameProduct && isWithin24h) {
                        alreadyClaimed = true;
                        existingClaim = {
                            ...claim,
                            id: doc.id,
                            claimedAt: claim.claimedAt
                        };
                        existingCouponCode = claim.couponCode;
                    }
                });
                
                if (alreadyClaimed) {
                    showBlockedPage(existingClaim);
                    return true;
                }
                
                // No recent claim found - generate new coupon
                await generateNewCoupon();
                return false;
                
            } catch (error) {
                console.error("Check error:", error);
                showError('Database error: ' + error.message);
                return false;
            }
        }
        
        async function generateNewCoupon() {
            try {
                // Generate unique coupon code
                const couponCode = 'SAVE' + 
                    Math.floor(Math.random() * 9000 + 1000) + 
                    String.fromCharCode(65 + Math.floor(Math.random() * 26));
                
                // Get client IP
                const clientIP = await getClientIP();
                
                // Prepare claim data with product
                const claimData = {
                    userId: currentUser.uid,
                    userFingerprint: userFingerprint,
                    userIP: clientIP,
                    adId: currentAd,
                    adName: decodeURIComponent(currentAd).replace(/_/g, ' '),
                    productId: currentProduct,
                    productName: decodeURIComponent(currentProduct).replace(/_/g, ' '),
                    hostId: currentHost,
                    hostName: decodeURIComponent(currentHost).replace(/_/g, ' '),
                    couponCode: couponCode,
                    claimedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: new Date(Date.now() + (CONFIG.BLOCK_HOURS * 60 * 60 * 1000)),
                    clientIP: clientIP,
                    userAgent: navigator.userAgent,
                    status: 'claimed',
                    redeemed: false,
                    redeemedAt: null,
                    redeemedBy: null
                };
                
                // Save to Firestore
                await db.collection('claims').add(claimData);
                
                // Store in localStorage to prevent refresh abuse
                localStorage.setItem(`claimed_${currentAd}_${currentProduct}_${currentUser.uid}`, 
                    JSON.stringify({
                        coupon: couponCode,
                        time: new Date().toISOString(),
                        expires: claimData.expiresAt
                    }));
                
                // Show success page
                showSuccessPage(claimData);
                
            } catch (error) {
                showError('Failed to generate coupon: ' + error.message);
            }
        }
        
        // === QR CODE FUNCTIONS (FIXED) ===
       // === QR CODE FUNCTIONS ===
// === SIMPLE BARCODE DISPLAY ===
// === SIMPLE UPC-STYLE BARCODE ===
// === CLEAN UPC BARCODE DISPLAY ===
// === WORKING QR CODE GENERATOR ===
function generateQRCode(elementId, text) {
    const element = document.getElementById(elementId);
    
    // Clear previous content
    element.innerHTML = '';
    
    // Create container for QR code
    const qrContainer = document.createElement('div');
    qrContainer.id = elementId + '_container';
    qrContainer.style.textAlign = 'center';
    qrContainer.style.padding = '10px';
    
    // Add loading text
    qrContainer.innerHTML = '<p>Generating QR code...</p>';
    element.appendChild(qrContainer);
    
    // Generate QR code with a small delay to ensure library is loaded
    setTimeout(() => {
        try {
            // Clear container
            qrContainer.innerHTML = '';
            
            // Check if QRCode library is available
            if (typeof QRCode === 'undefined') {
                throw new Error('QRCode library not loaded. Check CDN link.');
            }
            
            // Create new QR code
            new QRCode(qrContainer, {
                text: text,
                width: 180,
                height: 180,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // Add text below QR code
            const codeText = document.createElement('div');
            codeText.style.marginTop = '10px';
            codeText.style.fontFamily = "'Courier New', monospace";
            codeText.style.fontSize = '16px';
            codeText.style.color = '#666';
            codeText.innerHTML = `Code: <strong>${text}</strong>`;
            
            qrContainer.appendChild(codeText);
            
        } catch (error) {
            console.error('QR Code error:', error);
            
            // Fallback display
            qrContainer.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="color: #f44336; margin-bottom: 10px;">
                        ‚ö†Ô∏è QR Code generator error
                    </div>
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; 
                         border: 2px dashed #ddd; margin: 10px 0;">
                        <div style="font-family: 'Courier New', monospace; 
                             font-size: 24px; font-weight: bold; color: #2E7D32;">
                            ${text}
                        </div>
                    </div>
                    <div style="color: #666; font-size: 14px; margin-top: 10px;">
                        Please enter this code manually
                    </div>
                </div>
            `;
        }
    }, 100);
}

function generateSimpleBarcode(text) {
    let barcodeHTML = '';
    
    // Simple binary pattern based on characters
    for (let i = 0; i < Math.min(text.length, 12); i++) {
        const charCode = text.charCodeAt(i);
        const binary = charCode.toString(2).padStart(8, '0');
        
        // Take first 4 bits for pattern
        const pattern = binary.substring(0, 4);
        
        barcodeHTML += '<div style="display: inline-block;">';
        
        for (let j = 0; j < 4; j++) {
            const bit = pattern[j];
            const isBlack = bit === '1';
            const height = 50 + (j * 5);
            
            barcodeHTML += `
                <div style="
                    display: inline-block;
                    width: 3px;
                    height: ${height}px;
                    background: ${isBlack ? '#000' : '#fff'};
                    margin: 0 1px;
                    vertical-align: bottom;
                "></div>
            `;
        }
        
        barcodeHTML += '</div>';
    }
    
    return barcodeHTML;
}

function formatUPC(text) {
    // Format as XXX-XXX-XXX
    if (text.length <= 6) return text;
    if (text.length <= 9) return text.replace(/(.{3})(.{3})(.{3})/, '$1 $2 $3');
    return text.replace(/(.{4})(.{4})(.{4})/, '$1 $2 $3');
}

// Helper function to generate UPC-like lines
function generateUPCLines(text) {
    let linesHTML = '';
    
    // Simple algorithm to convert text to barcode pattern
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const charCode = char.charCodeAt(0);
        
        // Determine line properties based on character
        const isNumber = !isNaN(char);
        const lineHeight = 40 + (charCode % 30); // Height varies
        const lineWidth = 3 + (charCode % 5); // Width varies
        const isThick = charCode % 3 === 0; // Some lines are thicker
        
        // Color based on position
        const colorIndex = i % 4;
        const colors = ['#000000', '#333333', '#555555', '#777777'];
        
        linesHTML += `
            <div style="
                display: flex;
                flex-direction: column;
                align-items: center;
                margin: 0 ${isThick ? '2px' : '1px'};
            ">
                <!-- Barcode line -->
                <div style="
                    width: ${lineWidth}px;
                    height: ${lineHeight}px;
                    background-color: ${colors[colorIndex]};
                    border-radius: 1px;
                    margin-bottom: 2px;
                "></div>
                
                <!-- Character below (optional) -->
                <div style="
                    font-size: 9px;
                    color: #999;
                    margin-top: 3px;
                    font-family: 'Courier New', monospace;
                ">${isNumber ? char : ''}</div>
            </div>
        `;
    }
    
    return linesHTML;
}

// Helper function to generate barcode lines
function generateBarcodeLines(text) {
    let barcodeHTML = '';
    const colors = ['#000000', '#333333', '#666666', '#999999', '#CCCCCC'];
    
    // Convert text to simple barcode pattern
    for (let i = 0; i < text.length; i++) {
        const charCode = text.charCodeAt(i);
        const height = 30 + (charCode % 50); // Varying heights
        const width = 6;
        const colorIndex = charCode % colors.length;
        
        barcodeHTML += `
            <div style="
                width: ${width}px;
                height: ${height}px;
                background-color: ${colors[colorIndex]};
                margin: 0 1px;
                border-radius: 1px;
            "></div>
        `;
    }
    
    return barcodeHTML;
}
        
        // === UTILITY FUNCTIONS ===
        async function generateUserFingerprint() {
            try {
                // Get client IP
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const clientIP = ipData.ip;
                
                // Create fingerprint from multiple stable sources
                const fingerprintData = {
                    ip: clientIP,
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    screen: `${screen.width}x${screen.height}`,
                    cookiesEnabled: navigator.cookieEnabled
                };
                
                // Generate stable hash
                const dataString = JSON.stringify(fingerprintData);
                let hash = 0;
                for (let i = 0; i < dataString.length; i++) {
                    const char = dataString.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                
                return `fp_${Math.abs(hash).toString(36)}`;
                
            } catch (error) {
                // Fallback to simpler fingerprint
                return `fallback_${navigator.userAgent.substring(0, 50)}_${navigator.language}`;
            }
        }
        
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }
        
        // === UI FUNCTIONS ===
        function showSuccessPage(data) {
            // Change background to GREEN
            document.body.className = 'success-bg';
            
            // Hide loading, show success
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('success').classList.remove('hidden');
            document.getElementById('blocked').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            
            document.getElementById('couponCode').textContent = data.couponCode;
            document.getElementById('claimTime').textContent = new Date().toLocaleString();
            
            // Generate QR Code for the coupon
            generateQRCode('qrcode', data.couponCode);
            
            // Setup refresh protection
            setupRefreshProtection();
        }
        
        function showBlockedPage(existingClaim) {
            // Change background to RED
            document.body.className = 'blocked-bg';
            
            // Hide loading, show blocked
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('success').classList.add('hidden');
            document.getElementById('blocked').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
            
            const claimedTime = existingClaim.claimedAt?.toDate() || new Date();
            document.getElementById('blockedTime').textContent = claimedTime.toLocaleString();
            
            // Display the existing coupon code
            if (existingCouponCode) {
                document.getElementById('blockedCouponCode').textContent = existingCouponCode;
                // Generate QR Code for blocked page
                generateQRCode('blockedQrcode', existingCouponCode);
            } else {
                document.getElementById('blockedCouponCode').textContent = 'Not available';
            }
            
            // Check if coupon is redeemed
            if (existingClaim.redeemed) {
                document.getElementById('blockedStatus').textContent = 'Already redeemed';
                document.getElementById('blockedStatus').style.color = '#c62828';
                document.getElementById('blockedStatus').style.fontWeight = 'bold';
            }
            
            const nextAvailable = new Date(claimedTime.getTime() + (24 * 60 * 60 * 1000));
            startCountdown(nextAvailable);
        }
        
        function showError(message) {
            // Keep default background for errors
            document.body.className = '';
            
            // Hide all, show error
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('success').classList.add('hidden');
            document.getElementById('blocked').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
        
        function startCountdown(targetTime) {
            function updateCountdown() {
                const now = new Date();
                const diff = targetTime - now;
                
                if (diff <= 0) {
                    document.getElementById('countdown').innerHTML = 
                        '<span style="color: #4CAF50; font-size: 20px;">‚úÖ Ready to claim again!</span>';
                    return;
                }
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById('countdown').innerHTML = 
                    `<div style="font-size: 32px; font-weight: bold;">
                        ${hours.toString().padStart(2, '0')}:
                        ${minutes.toString().padStart(2, '0')}:
                        ${seconds.toString().padStart(2, '0')}
                    </div>
                    <p style="font-size: 16px;">Time until you can claim this ad again</p>`;
                
                // Continue updating every second
                setTimeout(updateCountdown, 1000);
            }
            
            // Start the countdown
            updateCountdown();
        }
        
        function copyCouponCode() {
            const couponCode = document.getElementById('blockedCouponCode').textContent;
            if (couponCode && couponCode !== 'Not available') {
                navigator.clipboard.writeText(couponCode).then(() => {
                    alert('Coupon code copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy code. Please take a screenshot instead.');
                });
            } else {
                alert('No coupon code available to copy.');
            }
        }
        
        function closePage() {
            // Provide options before closing
            if (confirm('Have you taken a screenshot of your coupon QR code?')) {
                window.close();
            } else {
                alert('Please take a screenshot before closing this page.');
            }
        }
        
        function setupRefreshProtection() {
            // Replace URL to prevent re-submission
            const newUrl = window.location.origin + window.location.pathname + 
                '?ad=' + encodeURIComponent(currentAd) + 
                '&product=' + encodeURIComponent(currentProduct) +
                '&host=' + encodeURIComponent(currentHost) + 
                '&claimed=true&t=' + Date.now();
            history.replaceState(null, null, newUrl);
            
            // Block refresh attempts
            window.onbeforeunload = function() {
                return "Your coupon has been saved. Do not refresh or you'll lose it!";
            };
            
            // Check if page was already loaded
            if (performance.navigation.type === 1) {
                const stored = localStorage.getItem(`claimed_${currentAd}_${currentProduct}_${currentUser.uid}`);
                if (stored) {
                    const storedData = JSON.parse(stored);
                    const mockClaim = {
                        claimedAt: { toDate: () => new Date(storedData.time) },
                        couponCode: storedData.coupon,
                        redeemed: false
                    };
                    existingCouponCode = storedData.coupon;
                    showBlockedPage(mockClaim);
                    return;
                }
            }
        }
    </script>
</body>
</html>
